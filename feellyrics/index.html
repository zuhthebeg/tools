<!DOCTYPE html>
<html lang="ko" id="htmlRoot">
<head>
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({"gtm.start":new Date().getTime(),event:"gtm.js"});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!="dataLayer"?"&l="+l:"";j.async=true;j.src="https://www.googletagmanager.com/gtm.js?id="+i+dl;f.parentNode.insertBefore(j,f)})(window,document,"script","dataLayer","GTM-MV8KQGJF");</script>
<!-- End Google Tag Manager -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ëŠë‚Œê°€ì‚¬ â€” Feel the Lyrics</title>
<meta name="description" content="ì™¸êµ­ ë…¸ë˜ë¥¼ í•œê¸€ ë°œìŒìœ¼ë¡œ! AIê°€ ë§Œë“¤ì–´ì£¼ëŠ” ëŠë‚Œê°€ì‚¬. ì˜ì–´, ì¼ë³¸ì–´, ìŠ¤í˜ì¸ì–´, ì¤‘êµ­ì–´ ë“± 10ê°œêµ­ 100ê³¡ ë°œìŒ ê°€ì‚¬ + ë…¸ë˜ë°© ëª¨ë“œ. Feel the Lyrics - sing foreign songs in your language!">
<meta name="keywords" content="ëŠë‚Œê°€ì‚¬, ë°œìŒê°€ì‚¬, ì™¸êµ­ë…¸ë˜ í•œê¸€, ê°€ì‚¬ ë°œìŒ, Feel Lyrics, pronunciation lyrics, karaoke, ë…¸ë˜ë°©, AI lyrics">
<!-- Open Graph -->
<meta property="og:title" content="ëŠë‚Œê°€ì‚¬ â€” Feel the Lyrics ğŸ¤">
<meta property="og:description" content="ì™¸êµ­ ë…¸ë˜ë¥¼ í•œê¸€ ë°œìŒìœ¼ë¡œ! AIê°€ ë§Œë“¤ì–´ì£¼ëŠ” ëŠë‚Œê°€ì‚¬. 10ê°œêµ­ 100ê³¡ ë°œìŒ ê°€ì‚¬ + ë…¸ë˜ë°© ëª¨ë“œ.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://tool.cocy.io/feellyrics/">
<meta property="og:image" content="https://tool.cocy.io/feellyrics/icon.svg">
<meta property="og:locale" content="ko_KR">
<meta property="og:locale:alternate" content="en_US">
<meta property="og:locale:alternate" content="ja_JP">
<meta property="og:locale:alternate" content="zh_TW">
<!-- Twitter Card -->
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ëŠë‚Œê°€ì‚¬ â€” Feel the Lyrics ğŸ¤">
<meta name="twitter:description" content="ì™¸êµ­ ë…¸ë˜ë¥¼ í•œê¸€ ë°œìŒìœ¼ë¡œ! AI ë°œìŒ ê°€ì‚¬ ìƒì„±ê¸° + ë…¸ë˜ë°© ëª¨ë“œ.">
<!-- Structured Data -->
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"ëŠë‚Œê°€ì‚¬ â€” Feel the Lyrics","url":"https://tool.cocy.io/feellyrics/","description":"AI-powered pronunciation lyrics generator for foreign songs. Supports 10 languages, 100+ songs, karaoke mode.","applicationCategory":"MusicApplication","operatingSystem":"Web","offers":{"@type":"Offer","price":"0","priceCurrency":"KRW"},"inLanguage":["ko","en","ja","zh-TW"]}
</script>
<!-- AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6634731722045607" crossorigin="anonymous"></script>
<link rel="canonical" href="https://tool.cocy.io/feellyrics/">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Outfit:wght@400;600;800&display=swap');

:root {
  --bg: #0a0a14;
  --card: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.08);
  --neon-pink: #ff2d78;
  --neon-cyan: #00e5ff;
  --neon-amber: #ffc857;
  --text: #e8e8f0;
  --text-dim: #8888a0;
  --radius: 16px;
  --glow-pink: 0 0 20px rgba(255,45,120,0.3);
  --glow-cyan: 0 0 20px rgba(0,229,255,0.3);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans KR', 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(255,45,120,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(0,229,255,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(255,200,87,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

/* Header */
.header { text-align: center; padding: 24px 0 16px; }
.header h1 {
  font-family: 'Outfit', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--neon-pink), var(--neon-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}
.header p { color: var(--text-dim); font-size: 0.85rem; margin-top: 4px; }

/* Navigation */
.nav-back {
  display: inline-flex; align-items: center; gap: 6px;
  color: var(--neon-cyan); font-size: 0.9rem; cursor: pointer;
  padding: 8px 0; margin-bottom: 8px; border: none; background: none;
  font-family: inherit;
}
.nav-back:hover { text-decoration: underline; }

/* Search */
.search-bar {
  display: flex; gap: 8px; margin-bottom: 20px;
}
.search-bar input {
  flex: 1; padding: 12px 16px; border-radius: 12px;
  background: var(--card); border: 1px solid var(--card-border);
  color: var(--text); font-size: 1rem; font-family: inherit;
  outline: none; transition: border-color 0.2s;
}
.search-bar input:focus { border-color: var(--neon-pink); }
.search-bar input::placeholder { color: var(--text-dim); }

/* Song Grid */
.song-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.song-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 16px; cursor: pointer;
  transition: all 0.25s ease; position: relative; overflow: hidden;
}
.song-card:hover {
  border-color: var(--neon-pink);
  box-shadow: var(--glow-pink);
  transform: translateY(-2px);
}
.song-card .album-art {
  width: 100%; aspect-ratio: 1; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem; margin-bottom: 10px;
}
.song-card .title {
  font-weight: 700; font-size: 0.9rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-card .artist {
  color: var(--text-dim); font-size: 0.78rem; margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-card .badge {
  position: absolute; top: 8px; right: 8px;
  background: var(--neon-pink); color: #fff; font-size: 0.65rem;
  padding: 2px 6px; border-radius: 6px; font-weight: 700;
}

/* Add Song Card */
.song-card.add-card {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  border-style: dashed; min-height: 180px;
}
.song-card.add-card .plus { font-size: 2rem; color: var(--text-dim); }
.song-card.add-card .label { color: var(--text-dim); font-size: 0.85rem; margin-top: 6px; }

/* Song Detail */
.song-info {
  display: flex; gap: 16px; align-items: flex-start;
  margin-bottom: 20px; padding: 16px;
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius);
}
.song-info .art {
  width: 80px; height: 80px; border-radius: 12px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem;
}
.song-info .meta { flex: 1; min-width: 0; }
.song-info .meta h2 { font-size: 1.2rem; font-weight: 800; }
.song-info .meta .artist { color: var(--text-dim); font-size: 0.9rem; }
.song-info .links { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.song-info .links a {
  font-size: 0.75rem; padding: 3px 8px; border-radius: 8px;
  text-decoration: none; color: var(--text); font-weight: 600;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
  transition: 0.2s;
}
.song-info .links a:hover { background: rgba(255,255,255,0.15); }

/* Toolbar */
.toolbar {
  display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
}
.toolbar button, .btn {
  padding: 8px 14px; border-radius: 10px; border: 1px solid var(--card-border);
  background: var(--card); color: var(--text); font-family: inherit;
  font-size: 0.82rem; cursor: pointer; transition: 0.2s; font-weight: 600;
}
.toolbar button:hover, .btn:hover {
  border-color: var(--neon-cyan); box-shadow: var(--glow-cyan);
}
.btn-primary {
  background: linear-gradient(135deg, var(--neon-pink), #ff6b9d) !important;
  border-color: var(--neon-pink) !important; color: #fff !important;
}
.btn-primary:hover { box-shadow: var(--glow-pink) !important; }
.btn-sm { padding: 6px 10px; font-size: 0.75rem; }

/* Line Editor */
.lines-container { display: flex; flex-direction: column; gap: 2px; }

.line-row {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
  border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.02);
  transition: 0.15s;
}
.line-row:hover { background: rgba(255,255,255,0.05); }
.line-row .original, .line-row .korean {
  padding: 10px 12px; font-size: 0.88rem; min-height: 42px;
  border: none; background: transparent; color: var(--text);
  font-family: inherit; outline: none; resize: none;
  line-height: 1.5;
}
.line-row .original {
  color: var(--text-dim); background: rgba(255,255,255,0.02);
  border-right: 1px solid rgba(255,255,255,0.05);
}
.line-row .korean { color: var(--neon-amber); font-weight: 700; }
.line-row .korean:focus { background: rgba(255,200,87,0.05); }
.line-row .korean::placeholder { color: rgba(255,200,87,0.3); font-weight: 400; }

.line-header {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
  padding: 8px 12px; font-size: 0.75rem; color: var(--text-dim);
  font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
}

/* Sections */
.section-label {
  font-size: 0.75rem; color: var(--neon-pink); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.1em;
  margin: 16px 0 8px; padding-left: 4px;
}

/* Karaoke Mode */
.karaoke-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: #050510;
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 24px; text-align: center;
  cursor: pointer; user-select: none;
}
.karaoke-overlay.active { display: flex; }
.karaoke-overlay .k-original {
  font-size: 1.1rem; color: var(--text-dim); margin-bottom: 16px;
  max-width: 90vw;
}
.karaoke-overlay .k-korean {
  font-size: 2.8rem; font-weight: 900; line-height: 1.3;
  color: var(--neon-amber);
  text-shadow: 0 0 40px rgba(255,200,87,0.4);
  max-width: 90vw;
  transition: opacity 0.3s;
}
.karaoke-overlay .k-progress {
  position: absolute; bottom: 40px;
  color: var(--text-dim); font-size: 0.85rem;
}
.karaoke-overlay .k-hint {
  position: absolute; bottom: 16px;
  color: rgba(255,255,255,0.2); font-size: 0.75rem;
}
.karaoke-overlay .k-close {
  position: absolute; top: 16px; right: 16px;
  font-size: 1.5rem; color: var(--text-dim);
  cursor: pointer; background: none; border: none;
  font-family: inherit;
}

/* Add/Edit Song Form */
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 0.8rem; color: var(--text-dim);
  margin-bottom: 4px; font-weight: 600;
}
.form-group input, .form-group textarea {
  width: 100%; padding: 10px 14px; border-radius: 10px;
  background: var(--card); border: 1px solid var(--card-border);
  color: var(--text); font-family: inherit; font-size: 0.9rem;
  outline: none; transition: border-color 0.2s;
}
.form-group input:focus, .form-group textarea:focus { border-color: var(--neon-cyan); }
.form-group textarea { min-height: 120px; resize: vertical; line-height: 1.6; }

/* Options row */
.options-row {
  display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
}
.option-chip {
  padding: 6px 12px; border-radius: 20px; font-size: 0.78rem;
  border: 1px solid var(--card-border); background: var(--card);
  color: var(--text-dim); cursor: pointer; transition: 0.2s;
  font-family: inherit; font-weight: 600;
}
.option-chip.active {
  border-color: var(--neon-cyan); color: var(--neon-cyan);
  background: rgba(0,229,255,0.1); box-shadow: var(--glow-cyan);
}

/* Export modal */
.modal-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,0.7); display: none;
  align-items: center; justify-content: center;
  padding: 24px;
}
.modal-overlay.active { display: flex; }
.modal-box {
  background: #15152a; border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 24px;
  width: 100%; max-width: 500px; max-height: 80dvh;
  overflow-y: auto;
}
.modal-box h3 { margin-bottom: 16px; font-size: 1.1rem; }
.modal-box pre {
  background: var(--card); padding: 16px; border-radius: 10px;
  font-family: 'Noto Sans KR', monospace; font-size: 0.85rem;
  line-height: 1.8; white-space: pre-wrap; word-break: break-all;
  color: var(--neon-amber); max-height: 50dvh; overflow-y: auto;
}
.modal-actions { display: flex; gap: 8px; margin-top: 16px; }

/* AI Loading */
.ai-loading {
  text-align: center; padding: 32px;
  color: var(--neon-cyan); font-size: 0.9rem;
}
.ai-loading .spinner {
  width: 32px; height: 32px; border: 3px solid rgba(0,229,255,0.2);
  border-top-color: var(--neon-cyan); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--neon-cyan); color: #000; font-weight: 700;
  padding: 10px 20px; border-radius: 10px; font-size: 0.85rem;
  z-index: 2000; opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* Responsive */
@media (max-width: 400px) {
  .song-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .song-card { padding: 12px; }
  .song-card .album-art { font-size: 2rem; }
  .karaoke-overlay .k-korean { font-size: 2rem; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* Lang switcher */
.lang-switcher {
  display: flex; justify-content: center; gap: 4px; margin-bottom: 8px;
}
.lang-btn {
  padding: 4px 10px; border-radius: 8px; border: 1px solid var(--card-border);
  background: var(--card); color: var(--text-dim); font-size: 0.75rem;
  cursor: pointer; font-family: inherit; font-weight: 600; transition: 0.2s;
}
.lang-btn.active {
  border-color: var(--neon-cyan); color: var(--neon-cyan);
  background: rgba(0,229,255,0.1);
}

/* Fade transition */
.view { animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MV8KQGJF" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<div class="app" id="app"></div>
<div class="karaoke-overlay" id="karaoke"></div>
<div class="modal-overlay" id="exportModal"></div>
<div class="toast" id="toast"></div>

<script src="songs.js"></script>
<script>
const LLM_URL = 'https://llm.cocy.io/v2/chat/completions';

// --- i18n ---
const LANGS = ['ko','en','ja','zh-TW'];
const LANG_LABELS = { ko:'í•œêµ­ì–´', en:'English', ja:'æ—¥æœ¬èª', 'zh-TW':'ç¹é«”ä¸­æ–‡' };
const I18N = {
  ko: {
    title: 'ëŠë‚Œê°€ì‚¬',
    subtitle: 'ì™¸êµ­ ë…¸ë˜ë¥¼ ë‚´ ì–¸ì–´ ë°œìŒìœ¼ë¡œ ë”°ë¼ ë¶€ë¥´ì',
    searchPlaceholder: 'ê³¡ ë˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰...',
    addSong: 'ìƒˆ ê³¡ ë“±ë¡',
    backToList: 'â† ëª©ë¡ìœ¼ë¡œ',
    aiSection: 'ğŸ¤– AI ëŠë‚Œê°€ì‚¬ ìƒì„±',
    optStretch: 'ğŸµ ìŒì ˆ ëŠ˜ë¦¬ê¸°',
    optStress: 'ğŸ’ª ê°•ì„¸ ê°•ì¡°',
    optRhyme: 'ğŸ¶ ë¼ì„ ëŠë‚Œ',
    btnAi: 'âœ¨ AI ìƒì„±',
    btnKaraoke: 'ğŸ¤ ë…¸ë˜ë°©',
    btnAddLine: '+ ì¤„ ì¶”ê°€',
    btnExport: 'ğŸ“¤ ë‚´ë³´ë‚´ê¸°',
    colOriginal: 'ì›ë¬¸ ê°€ì‚¬',
    colPhonetic: 'í•œê¸€ ëŠë‚Œê°€ì‚¬',
    phoneticPlaceholder: 'í•œê¸€ ë°œìŒ ì…ë ¥...',
    addTitle: 'ê³¡ ì œëª©',
    addArtist: 'ì•„í‹°ìŠ¤íŠ¸',
    addYoutube: 'YouTube ë§í¬',
    addSpotify: 'Spotify ë§í¬',
    addLyrics: 'ê°€ì‚¬ (í•œ ì¤„ì— í•˜ë‚˜ì”©)',
    btnRegister: 'ë“±ë¡í•˜ê¸°',
    btnCancel: 'ì·¨ì†Œ',
    newSongTitle: 'ğŸµ ìƒˆ ê³¡ ë“±ë¡',
    toastRegistered: 'ê³¡ì´ ë“±ë¡ë˜ì—ˆì–´ìš”!',
    toastDeleted: 'ì‚­ì œ ì™„ë£Œ',
    toastCopied: 'ë³µì‚¬ ì™„ë£Œ!',
    toastAiDone: 'âœ¨ ëŠë‚Œê°€ì‚¬ ìƒì„± ì™„ë£Œ!',
    toastNoLyrics: 'ì›ë¬¸ ê°€ì‚¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”',
    toastNoPhonetic: 'ë°œìŒ ê°€ì‚¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”',
    toastRequired: 'ì œëª©ê³¼ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”',
    confirmDelete: 'ì´ ê³¡ì„ ì‚­ì œí• ê¹Œìš”?',
    aiLoading: 'AIê°€ í•œê¸€ ëŠë‚Œê°€ì‚¬ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...',
    aiFailed: 'ìƒì„± ì‹¤íŒ¨',
    aiRetry: 'ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”',
    exportTitle: 'ğŸ“¤ ë‚´ë³´ë‚´ê¸°',
    exportCopy: 'ğŸ“‹ í…ìŠ¤íŠ¸ ë³µì‚¬',
    exportClose: 'ë‹«ê¸°',
    karaokeEnd: 'ğŸ¤ ë! ì˜í–ˆì–´ìš”!',
    karaokeTapBack: 'íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°',
    karaokeHint: 'íƒ­ ë˜ëŠ” â†’í‚¤ë¡œ ë‹¤ìŒ',
    notEntered: '(ë¯¸ì…ë ¥)',
  },
  en: {
    title: 'Feel Lyrics',
    subtitle: 'Sing foreign songs with phonetics in your language',
    searchPlaceholder: 'Search song or artist...',
    addSong: 'Add Song',
    backToList: 'â† Back',
    aiSection: 'ğŸ¤– AI Phonetic Generation',
    optStretch: 'ğŸµ Stretch Syllables',
    optStress: 'ğŸ’ª Stress Marks',
    optRhyme: 'ğŸ¶ Rhyme Feel',
    btnAi: 'âœ¨ AI Generate',
    btnKaraoke: 'ğŸ¤ Karaoke',
    btnAddLine: '+ Add Line',
    btnExport: 'ğŸ“¤ Export',
    colOriginal: 'Original Lyrics',
    colPhonetic: 'English Phonetics',
    phoneticPlaceholder: 'Type phonetics...',
    addTitle: 'Song Title',
    addArtist: 'Artist',
    addYoutube: 'YouTube Link',
    addSpotify: 'Spotify Link',
    addLyrics: 'Lyrics (one line each)',
    btnRegister: 'Register',
    btnCancel: 'Cancel',
    newSongTitle: 'ğŸµ Add New Song',
    toastRegistered: 'Song added!',
    toastDeleted: 'Deleted',
    toastCopied: 'Copied!',
    toastAiDone: 'âœ¨ Phonetics generated!',
    toastNoLyrics: 'Enter original lyrics first',
    toastNoPhonetic: 'Enter phonetics first',
    toastRequired: 'Title and artist required',
    confirmDelete: 'Delete this song?',
    aiLoading: 'AI is generating phonetics...',
    aiFailed: 'Generation failed',
    aiRetry: 'Try again or type manually',
    exportTitle: 'ğŸ“¤ Export',
    exportCopy: 'ğŸ“‹ Copy Text',
    exportClose: 'Close',
    karaokeEnd: 'ğŸ¤ Great job!',
    karaokeTapBack: 'Tap to go back',
    karaokeHint: 'Tap or â†’ for next',
    notEntered: '(empty)',
  },
  ja: {
    title: 'ãƒ•ã‚£ãƒ¼ãƒ«ãƒªãƒªãƒƒã‚¯ã‚¹',
    subtitle: 'å¤–å›½ã®æ­Œã‚’ã‚«ã‚¿ã‚«ãƒŠç™ºéŸ³ã§æ­ŒãŠã†',
    searchPlaceholder: 'æ›²ã¾ãŸã¯ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆæ¤œç´¢...',
    addSong: 'æ–°æ›²è¿½åŠ ',
    backToList: 'â† ä¸€è¦§ã¸',
    aiSection: 'ğŸ¤– AI ã‚«ã‚¿ã‚«ãƒŠç™ºéŸ³ç”Ÿæˆ',
    optStretch: 'ğŸµ éŸ³ç¯€ã‚’ä¼¸ã°ã™',
    optStress: 'ğŸ’ª ã‚¢ã‚¯ã‚»ãƒ³ãƒˆå¼·èª¿',
    optRhyme: 'ğŸ¶ ãƒ©ã‚¤ãƒ æ„Ÿ',
    btnAi: 'âœ¨ AIç”Ÿæˆ',
    btnKaraoke: 'ğŸ¤ ã‚«ãƒ©ã‚ªã‚±',
    btnAddLine: '+ è¡Œè¿½åŠ ',
    btnExport: 'ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
    colOriginal: 'åŸæ–‡æ­Œè©',
    colPhonetic: 'ã‚«ã‚¿ã‚«ãƒŠç™ºéŸ³',
    phoneticPlaceholder: 'ã‚«ã‚¿ã‚«ãƒŠã§ç™ºéŸ³ã‚’å…¥åŠ›...',
    addTitle: 'æ›²å',
    addArtist: 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ',
    addYoutube: 'YouTubeãƒªãƒ³ã‚¯',
    addSpotify: 'Spotifyãƒªãƒ³ã‚¯',
    addLyrics: 'æ­Œè©ï¼ˆ1è¡Œãšã¤ï¼‰',
    btnRegister: 'ç™»éŒ²',
    btnCancel: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
    newSongTitle: 'ğŸµ æ–°æ›²è¿½åŠ ',
    toastRegistered: 'æ›²ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼',
    toastDeleted: 'å‰Šé™¤å®Œäº†',
    toastCopied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼',
    toastAiDone: 'âœ¨ ç™ºéŸ³ç”Ÿæˆå®Œäº†ï¼',
    toastNoLyrics: 'å…ˆã«åŸæ–‡æ­Œè©ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    toastNoPhonetic: 'å…ˆã«ã‚«ã‚¿ã‚«ãƒŠç™ºéŸ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    toastRequired: 'æ›²åã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
    confirmDelete: 'ã“ã®æ›²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ',
    aiLoading: 'AIãŒã‚«ã‚¿ã‚«ãƒŠç™ºéŸ³ã‚’ç”Ÿæˆä¸­...',
    aiFailed: 'ç”Ÿæˆå¤±æ•—',
    aiRetry: 'æ‰‹å‹•å…¥åŠ›ã™ã‚‹ã‹å†è©¦è¡Œã—ã¦ãã ã•ã„',
    exportTitle: 'ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ',
    exportCopy: 'ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ”ãƒ¼',
    exportClose: 'é–‰ã˜ã‚‹',
    karaokeEnd: 'ğŸ¤ ãŠç–²ã‚Œæ§˜ï¼',
    karaokeTapBack: 'ã‚¿ãƒƒãƒ—ã§æˆ»ã‚‹',
    karaokeHint: 'ã‚¿ãƒƒãƒ—ã¾ãŸã¯â†’ã‚­ãƒ¼ã§æ¬¡ã¸',
    notEntered: 'ï¼ˆæœªå…¥åŠ›ï¼‰',
  },
  'zh-TW': {
    title: 'æ„Ÿè¦ºæ­Œè©',
    subtitle: 'ç”¨ä¸­æ–‡æ³¨éŸ³å”±å¤–åœ‹æ­Œæ›²',
    searchPlaceholder: 'æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹...',
    addSong: 'æ–°å¢æ­Œæ›²',
    backToList: 'â† è¿”å›åˆ—è¡¨',
    aiSection: 'ğŸ¤– AI ä¸­æ–‡è«§éŸ³ç”Ÿæˆ',
    optStretch: 'ğŸµ å»¶é•·éŸ³ç¯€',
    optStress: 'ğŸ’ª é‡éŸ³æ¨™è¨˜',
    optRhyme: 'ğŸ¶ æŠ¼éŸ»æ„Ÿ',
    btnAi: 'âœ¨ AI ç”Ÿæˆ',
    btnKaraoke: 'ğŸ¤ KTVæ¨¡å¼',
    btnAddLine: '+ æ–°å¢è¡Œ',
    btnExport: 'ğŸ“¤ åŒ¯å‡º',
    colOriginal: 'åŸæ–‡æ­Œè©',
    colPhonetic: 'ä¸­æ–‡è«§éŸ³',
    phoneticPlaceholder: 'è¼¸å…¥ä¸­æ–‡è«§éŸ³...',
    addTitle: 'æ­Œæ›²åç¨±',
    addArtist: 'æ­Œæ‰‹',
    addYoutube: 'YouTube é€£çµ',
    addSpotify: 'Spotify é€£çµ',
    addLyrics: 'æ­Œè©ï¼ˆæ¯è¡Œä¸€å¥ï¼‰',
    btnRegister: 'æ–°å¢',
    btnCancel: 'å–æ¶ˆ',
    newSongTitle: 'ğŸµ æ–°å¢æ­Œæ›²',
    toastRegistered: 'æ­Œæ›²å·²æ–°å¢ï¼',
    toastDeleted: 'å·²åˆªé™¤',
    toastCopied: 'å·²è¤‡è£½ï¼',
    toastAiDone: 'âœ¨ ç™¼éŸ³ç”Ÿæˆå®Œæˆï¼',
    toastNoLyrics: 'è«‹å…ˆè¼¸å…¥åŸæ–‡æ­Œè©',
    toastNoPhonetic: 'è«‹å…ˆè¼¸å…¥ä¸­æ–‡è«§éŸ³',
    toastRequired: 'è«‹è¼¸å…¥æ­Œæ›²åç¨±å’Œæ­Œæ‰‹',
    confirmDelete: 'è¦åˆªé™¤é€™é¦–æ­Œå—ï¼Ÿ',
    aiLoading: 'AI æ­£åœ¨ç”Ÿæˆä¸­æ–‡è«§éŸ³...',
    aiFailed: 'ç”Ÿæˆå¤±æ•—',
    aiRetry: 'è«‹æ‰‹å‹•è¼¸å…¥æˆ–é‡è©¦',
    exportTitle: 'ğŸ“¤ åŒ¯å‡º',
    exportCopy: 'ğŸ“‹ è¤‡è£½æ–‡å­—',
    exportClose: 'é—œé–‰',
    karaokeEnd: 'ğŸ¤ å¤ªæ£’äº†ï¼',
    karaokeTapBack: 'é»æ“Šè¿”å›',
    karaokeHint: 'é»æ“Šæˆ–â†’éµä¸‹ä¸€è¡Œ',
    notEntered: 'ï¼ˆæœªè¼¸å…¥ï¼‰',
  },
};

let currentLang = localStorage.getItem('feellyrics_lang') || (navigator.language.startsWith('ja') ? 'ja' : navigator.language.startsWith('zh') ? 'zh-TW' : navigator.language.startsWith('en') ? 'en' : 'ko');
if (!I18N[currentLang]) currentLang = 'ko';

function t(key) { return I18N[currentLang]?.[key] || I18N.ko[key] || key; }

function setLang(lang) {
  currentLang = lang;
  localStorage.setItem('feellyrics_lang', lang);
  document.getElementById('htmlRoot').lang = lang === 'zh-TW' ? 'zh-Hant' : lang;
  render();
}

function renderLangSwitcher() {
  return `<div class="lang-switcher">${LANGS.map(l =>
    `<button class="lang-btn ${l===currentLang?'active':''}" data-lang="${l}">${LANG_LABELS[l]}</button>`
  ).join('')}</div>`;
}


// SAMPLE_SONGS loaded from songs.js


// --- State ---
let state = {
  view: 'home', // home | editor | add
  songs: [],
  currentSongId: null,
  search: '',
  karaokeIndex: 0,
  aiOptions: { stretch: false, stress: false, rhyme: false },
};

function loadState() {
  const saved = localStorage.getItem('feellyrics_songs');
  if (saved) {
    state.songs = JSON.parse(saved);
  } else {
    state.songs = JSON.parse(JSON.stringify(SAMPLE_SONGS));
    saveState();
  }
}

function saveState() {
  localStorage.setItem('feellyrics_songs', JSON.stringify(state.songs));
}

function getCurrentSong() {
  return state.songs.find(s => s.id === state.currentSongId);
}

// --- Toast ---
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// --- Render ---
function render() {
  const app = document.getElementById('app');
  switch(state.view) {
    case 'home': app.innerHTML = renderHome(); break;
    case 'editor': app.innerHTML = renderEditor(); break;
    case 'add': app.innerHTML = renderAddForm(); break;
  }
  bindEvents();
}

function renderHome() {
  const filtered = state.songs.filter(s =>
    !state.search || s.title.toLowerCase().includes(state.search.toLowerCase()) ||
    s.artist.toLowerCase().includes(state.search.toLowerCase())
  );
  return `
    <div class="view">
      ${renderLangSwitcher()}
      <div class="header">
        <h1>ğŸ¤ ${t('title')}</h1>
        <p>${t('subtitle')}</p>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="${t('searchPlaceholder')}" value="${escHtml(state.search)}" id="searchInput">
      </div>
      <div class="song-grid">
        ${filtered.map(s => `
          <div class="song-card" data-action="open" data-id="${s.id}">
            <div class="album-art" style="background:${s.gradient}">${s.emoji}</div>
            <div class="title">${escHtml(s.title)}</div>
            <div class="artist">${escHtml(s.artist)}</div>
            ${s.id.startsWith('s') ? '<span class="badge">SAMPLE</span>' : ''}
          </div>
        `).join('')}
        <div class="song-card add-card" data-action="add">
          <div class="plus">+</div>
          <div class="label">${t('addSong')}</div>
        </div>
      </div>
    </div>
  `;
}

function renderEditor() {
  const song = getCurrentSong();
  if (!song) { state.view = 'home'; return renderHome(); }
  const linkLabels = { youtube: 'â–¶ YouTube', spotify: 'ğŸµ Spotify', melon: 'ğŸˆ Melon' };
  return `
    <div class="view">
      <button class="nav-back" data-action="back">${t('backToList')}</button>
      <div class="song-info">
        <div class="art" style="background:${song.gradient}">${song.emoji}</div>
        <div class="meta">
          <h2>${escHtml(song.title)}</h2>
          <div class="artist">${escHtml(song.artist)}</div>
          <div class="links">
            ${Object.entries(song.links||{}).map(([k,v]) => v ? `<a href="${escHtml(v)}" target="_blank" rel="noopener">${linkLabels[k]||k}</a>` : '').join('')}
          </div>
        </div>
      </div>

      <div class="section-label">${t('aiSection')}</div>
      <div class="options-row">
        <button class="option-chip ${state.aiOptions.stretch?'active':''}" data-option="stretch">${t('optStretch')}</button>
        <button class="option-chip ${state.aiOptions.stress?'active':''}" data-option="stress">${t('optStress')}</button>
        <button class="option-chip ${state.aiOptions.rhyme?'active':''}" data-option="rhyme">${t('optRhyme')}</button>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" data-action="aiGenerate">${t('btnAi')}</button>
        <button class="btn" data-action="karaoke">${t('btnKaraoke')}</button>
        <button class="btn" data-action="addLine">${t('btnAddLine')}</button>
        <button class="btn" data-action="export">${t('btnExport')}</button>
        ${!song.id.startsWith('s') ? '<button class="btn" data-action="deleteSong" style="color:#ff4444">ğŸ—‘</button>' : ''}
      </div>

      <div id="aiStatus"></div>

      <div class="line-header"><span>${t('colOriginal')}</span><span>${t('colPhonetic')}</span></div>
      <div class="lines-container" id="linesContainer">
        ${song.lines.map((l, i) => `
          <div class="line-row" data-idx="${i}">
            <textarea class="original" rows="1" data-field="original" data-idx="${i}">${escHtml(l.original)}</textarea>
            <textarea class="korean" rows="1" placeholder="${t('phoneticPlaceholder')}" data-field="korean" data-idx="${i}">${escHtml(l.korean)}</textarea>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderAddForm() {
  return `
    <div class="view">
      <button class="nav-back" data-action="back">${t('backToList')}</button>
      <div class="header" style="padding-bottom:8px"><h1>${t('newSongTitle')}</h1></div>
      <div class="form-group">
        <label>${t('addTitle')} *</label>
        <input id="addTitle" placeholder="Shape of You">
      </div>
      <div class="form-group">
        <label>${t('addArtist')} *</label>
        <input id="addArtist" placeholder="Ed Sheeran">
      </div>
      <div class="form-group">
        <label>${t('addYoutube')}</label>
        <input id="addYoutube" placeholder="https://www.youtube.com/watch?v=...">
      </div>
      <div class="form-group">
        <label>${t('addSpotify')}</label>
        <input id="addSpotify" placeholder="https://open.spotify.com/track/...">
      </div>
      <div class="form-group">
        <label>${t('addLyrics')}</label>
        <textarea id="addLyrics" placeholder="Is this the real life?&#10;Is this just fantasy?&#10;Caught in a landslide..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" data-action="saveSong" style="flex:1">${t('btnRegister')}</button>
        <button class="btn" data-action="back">${t('btnCancel')}</button>
      </div>
    </div>
  `;
}

// --- Events ---
function bindEvents() {
  const app = document.getElementById('app');

  // Search
  const si = document.getElementById('searchInput');
  if (si) si.addEventListener('input', e => { state.search = e.target.value; render(); });

  // Lang switcher
  app.querySelectorAll('.lang-btn').forEach(el => {
    el.addEventListener('click', () => setLang(el.dataset.lang));
  });

  // Click delegation
  app.addEventListener('click', handleClick);

  // Textarea auto-resize + save
  app.querySelectorAll('textarea[data-field]').forEach(ta => {
    autoResize(ta);
    ta.addEventListener('input', e => {
      autoResize(e.target);
      const song = getCurrentSong();
      if (!song) return;
      const idx = +e.target.dataset.idx;
      const field = e.target.dataset.field;
      song.lines[idx][field] = e.target.value;
      saveState();
    });
  });

  // Option chips
  app.querySelectorAll('.option-chip').forEach(el => {
    el.addEventListener('click', () => {
      const opt = el.dataset.option;
      state.aiOptions[opt] = !state.aiOptions[opt];
      el.classList.toggle('active');
    });
  });
}

function handleClick(e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const action = btn.dataset.action;

  switch(action) {
    case 'open':
      state.currentSongId = btn.dataset.id;
      state.view = 'editor';
      render();
      break;
    case 'back':
      state.view = 'home';
      render();
      break;
    case 'add':
      state.view = 'add';
      render();
      break;
    case 'karaoke':
      openKaraoke();
      break;
    case 'aiGenerate':
      aiGenerate();
      break;
    case 'addLine':
      addLine();
      break;
    case 'export':
      openExport();
      break;
    case 'saveSong':
      saveSong();
      break;
    case 'deleteSong':
      deleteSong();
      break;
  }
}

function autoResize(ta) {
  ta.style.height = 'auto';
  ta.style.height = ta.scrollHeight + 'px';
}

// --- Actions ---
function addLine() {
  const song = getCurrentSong();
  if (!song) return;
  song.lines.push({ original: '', korean: '' });
  saveState();
  render();
  // Focus last korean input
  setTimeout(() => {
    const all = document.querySelectorAll('.korean');
    if (all.length) all[all.length-1].focus();
  }, 50);
}

function saveSong() {
  const title = document.getElementById('addTitle').value.trim();
  const artist = document.getElementById('addArtist').value.trim();
  if (!title || !artist) { toast(t('toastRequired')); return; }
  const lyrics = document.getElementById('addLyrics').value.trim();
  const lines = lyrics ? lyrics.split('\n').filter(l => l.trim()).map(l => ({ original: l.trim(), korean: '' })) : [{ original: '', korean: '' }];
  const emojis = ['ğŸµ','ğŸ¶','ğŸ¹','ğŸ·','ğŸº','ğŸ¥','ğŸ»','ğŸª—','ğŸ™ï¸','ğŸ§'];
  const gradients = [
    'linear-gradient(135deg,#667eea,#764ba2)',
    'linear-gradient(135deg,#f093fb,#f5576c)',
    'linear-gradient(135deg,#4facfe,#00f2fe)',
    'linear-gradient(135deg,#43e97b,#38f9d7)',
    'linear-gradient(135deg,#fa709a,#fee140)',
  ];
  const song = {
    id: 'u' + Date.now(),
    title, artist,
    emoji: emojis[Math.floor(Math.random()*emojis.length)],
    gradient: gradients[Math.floor(Math.random()*gradients.length)],
    links: {
      youtube: document.getElementById('addYoutube').value.trim() || null,
      spotify: document.getElementById('addSpotify').value.trim() || null,
    },
    lines
  };
  state.songs.unshift(song);
  saveState();
  state.currentSongId = song.id;
  state.view = 'editor';
  render();
  toast(t('toastRegistered'));
}

function deleteSong() {
  if (!confirm(t('confirmDelete'))) return;
  state.songs = state.songs.filter(s => s.id !== state.currentSongId);
  saveState();
  state.view = 'home';
  render();
  toast(t('toastDeleted'));
}

// --- AI Generation ---
async function aiGenerate() {
  const song = getCurrentSong();
  if (!song) return;
  const originals = song.lines.map(l => l.original).filter(l => l.trim());
  if (!originals.length) { toast(t('toastNoLyrics')); return; }

  const statusEl = document.getElementById('aiStatus');
  statusEl.innerHTML = `<div class="ai-loading"><div class="spinner"></div>${t('aiLoading')}</div>`;

  const PHONETIC_PROMPTS = {
    ko: {
      instruction: 'ë‹¤ìŒ ê°€ì‚¬ë¥¼ í•œêµ­ì–´ ë°œìŒ(ëŠë‚Œê°€ì‚¬)ìœ¼ë¡œ ë³€í™˜í•´ì¤˜.',
      rules: '- ë°œìŒì„ í•œê¸€ë¡œ ìµœëŒ€í•œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œê¸°\n- ë…¸ë˜ ë¶€ë¥¼ ë•Œ ë¦¬ë“¬ì— ë§ê²Œ ìŒì ˆ ìˆ˜ ì¡°ì ˆ\n- ì›ë¬¸ì˜ ëŠë‚Œì„ ì‚´ë ¤ì„œ ë³€í™˜',
      stretch: '- ìŒì ˆì„ ì•½ê°„ ëŠ˜ë ¤ì„œ ë” ë¶€ë¥´ê¸° ì‰½ê²Œ (ì˜ˆ: "love" â†’ "ëŸ¬~ë¸Œ")',
      stress: '- ê°•ì„¸ê°€ ìˆëŠ” ìŒì ˆì€ ~ë¡œ ê°•ì¡° í‘œì‹œ',
      rhyme: '- í•œêµ­ì–´ì—ì„œë„ ë¼ì„/ìš´ìœ¨ì´ ëŠê»´ì§€ë„ë¡ ë°œìŒ ì¡°ì •',
      example: 'ì˜ˆ: "I love you" â†’ "ì•„ì´ ëŸ¬ë¸Œ ìœ "',
    },
    en: {
      instruction: 'Convert the following lyrics into English phonetic approximation.',
      rules: '- Write pronunciation using English alphabet, as naturally singable as possible\n- Match rhythm and syllable count of the original\n- Preserve the feel of the original',
      stretch: '- Stretch syllables for easier singing (e.g., "ì‚¬ë‘" â†’ "saa-rang~")',
      stress: '- Mark stressed syllables with ~ or caps',
      rhyme: '- Adjust phonetics so English rhymes/flow feel natural',
      example: 'e.g., "ì‚¬ë‘í•´" â†’ "sa-rang-hae"',
    },
    ja: {
      instruction: 'æ¬¡ã®æ­Œè©ã‚’ã‚«ã‚¿ã‚«ãƒŠã®ç™ºéŸ³è¡¨è¨˜ã«å¤‰æ›ã—ã¦ãã ã•ã„ã€‚',
      rules: '- ã‚«ã‚¿ã‚«ãƒŠã§æœ€ã‚‚è‡ªç„¶ãªç™ºéŸ³è¡¨è¨˜ã«ã™ã‚‹\n- æ­Œã®ãƒªã‚ºãƒ ã«åˆã‚ã›ã¦éŸ³ç¯€æ•°ã‚’èª¿æ•´\n- åŸæ–‡ã®é›°å›²æ°—ã‚’æ´»ã‹ã™',
      stretch: '- éŸ³ç¯€ã‚’ä¼¸ã°ã—ã¦æ­Œã„ã‚„ã™ãï¼ˆä¾‹: "love" â†’ "ãƒ©ã€œãƒ´"ï¼‰',
      stress: '- ã‚¢ã‚¯ã‚»ãƒ³ãƒˆã®ã‚ã‚‹éŸ³ç¯€ã¯ã€œã§å¼·èª¿',
      rhyme: '- æ—¥æœ¬èªã§ã‚‚ãƒ©ã‚¤ãƒ ãƒ»éŸ»ã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹ã‚ˆã†ã«èª¿æ•´',
      example: 'ä¾‹: "I love you" â†’ "ã‚¢ã‚¤ ãƒ©ãƒ´ ãƒ¦ãƒ¼"',
    },
    'zh-TW': {
      instruction: 'å°‡ä»¥ä¸‹æ­Œè©è½‰æ›ç‚ºä¸­æ–‡è«§éŸ³ï¼ˆç”¨ä¸­æ–‡å­—æ¨¡æ“¬ç™¼éŸ³ï¼‰ã€‚',
      rules: '- ç”¨ä¸­æ–‡å­—ä¾†æ¨¡æ“¬å¤–èªç™¼éŸ³ï¼Œç›¡é‡è‡ªç„¶\n- é…åˆæ­Œæ›²ç¯€å¥èª¿æ•´éŸ³ç¯€\n- ä¿ç•™åŸæ–‡çš„æ„Ÿè¦º',
      stretch: '- é©ç•¶å»¶é•·éŸ³ç¯€è®“æ¼”å”±æ›´é †ï¼ˆä¾‹: "love" â†’ "æ‹‰ï½å¤«"ï¼‰',
      stress: '- é‡éŸ³éŸ³ç¯€ç”¨ï½æ¨™è¨˜',
      rhyme: '- èª¿æ•´è«§éŸ³è®“ä¸­æ–‡ä¹Ÿæœ‰æŠ¼éŸ»æ„Ÿ',
      example: 'ä¾‹: "I love you" â†’ "æ„› æ‹‰å¤« æ²¹"',
    },
  };

  const pp = PHONETIC_PROMPTS[currentLang] || PHONETIC_PROMPTS.ko;
  let optionText = '';
  if (state.aiOptions.stretch) optionText += '\n' + pp.stretch;
  if (state.aiOptions.stress) optionText += '\n' + pp.stress;
  if (state.aiOptions.rhyme) optionText += '\n' + pp.rhyme;

  const prompt = `${pp.instruction}
ê·œì¹™/Rules:
${pp.rules}${optionText}

${pp.example}

í˜•ì‹/Format: ë°˜ë“œì‹œ JSON ë°°ì—´ë¡œë§Œ ì‘ë‹µ (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
[{"original":"ì›ë¬¸","korean":"ë°œìŒí‘œê¸°"},...]

ê°€ì‚¬/Lyrics:
${originals.map((l,i) => `${i+1}. ${l}`).join('\n')}`;

  try {
    const res = await fetch(LLM_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ model: 'spark', messages: [{ role: 'user', content: prompt }] })
    });
    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '';

    // Robust parse: strip think tags, find JSON
    let cleaned = text.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
    const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨');
    const result = JSON.parse(jsonMatch[0]);

    // Apply results
    result.forEach((r, i) => {
      if (i < song.lines.length && r.korean) {
        song.lines[i].korean = r.korean;
      }
    });
    saveState();
    statusEl.innerHTML = '';
    render();
    toast(t('toastAiDone'));
  } catch(err) {
    statusEl.innerHTML = `<div style="color:#ff4444;text-align:center;padding:12px;font-size:0.85rem">${t('aiFailed')}: ${escHtml(err.message)}<br><span style="color:var(--text-dim)">${t('aiRetry')}</span></div>`;
  }
}

// --- Karaoke ---
function openKaraoke() {
  const song = getCurrentSong();
  if (!song || !song.lines.length) return;
  const nonEmpty = song.lines.filter(l => l.korean.trim());
  if (!nonEmpty.length) { toast(t('toastNoPhonetic')); return; }
  state.karaokeIndex = 0;
  renderKaraoke(song, nonEmpty);
}

function renderKaraoke(song, lines) {
  const overlay = document.getElementById('karaoke');
  const i = state.karaokeIndex;
  const line = lines[Math.min(i, lines.length - 1)];
  const done = i >= lines.length;

  overlay.innerHTML = `
    <button class="k-close" id="kClose">âœ•</button>
    ${done ? `
      <div class="k-korean" style="font-size:1.8rem">${t('karaokeEnd')}</div>
      <div class="k-progress">${t('karaokeTapBack')}</div>
    ` : `
      <div class="k-original">${escHtml(line.original)}</div>
      <div class="k-korean">${escHtml(line.korean)}</div>
      <div class="k-progress">${i+1} / ${lines.length}</div>
      <div class="k-hint">${t('karaokeHint')}</div>
    `}
  `;
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';

  const close = () => {
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    overlay.removeEventListener('click', advance);
    document.removeEventListener('keydown', keyHandler);
  };

  const advance = (e) => {
    if (e.target.id === 'kClose') { close(); return; }
    if (done) { close(); return; }
    state.karaokeIndex++;
    renderKaraoke(song, lines);
  };

  const keyHandler = (e) => {
    if (e.key === 'Escape') { close(); return; }
    if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); advance(e); }
    if (e.key === 'ArrowLeft' && state.karaokeIndex > 0) {
      e.preventDefault(); state.karaokeIndex--; renderKaraoke(song, lines);
    }
  };

  // Re-attach (previous listeners removed by innerHTML replacement)
  setTimeout(() => {
    overlay.addEventListener('click', advance);
    document.addEventListener('keydown', keyHandler);
    document.getElementById('kClose').addEventListener('click', close);
  }, 10);
}

// --- Export ---
function openExport() {
  const song = getCurrentSong();
  if (!song) return;
  const text = `${song.title} â€” ${song.artist}\n${'â”€'.repeat(30)}\n\n` +
    song.lines.map(l => `${l.original}\n${l.korean || t('notEntered')}\n`).join('\n');

  const modal = document.getElementById('exportModal');
  modal.innerHTML = `
    <div class="modal-box">
      <h3>${t('exportTitle')}</h3>
      <pre id="exportText">${escHtml(text)}</pre>
      <div class="modal-actions">
        <button class="btn btn-primary" id="copyBtn">${t('exportCopy')}</button>
        <button class="btn" id="closeExport">${t('exportClose')}</button>
      </div>
    </div>
  `;
  modal.classList.add('active');

  document.getElementById('copyBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(text).then(() => toast(t('toastCopied'))).catch(() => {
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      toast(t('toastCopied'));
    });
  });
  document.getElementById('closeExport').addEventListener('click', () => modal.classList.remove('active'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
}

// --- Util ---
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// --- Init ---
loadState();
render();
</script>
</body>
</html>
