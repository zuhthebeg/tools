<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ëŠë‚Œê°€ì‚¬ â€” Feel the Lyrics</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤</text></svg>">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;900&family=Outfit:wght@400;600;800&display=swap');

:root {
  --bg: #0a0a14;
  --card: rgba(255,255,255,0.04);
  --card-border: rgba(255,255,255,0.08);
  --neon-pink: #ff2d78;
  --neon-cyan: #00e5ff;
  --neon-amber: #ffc857;
  --text: #e8e8f0;
  --text-dim: #8888a0;
  --radius: 16px;
  --glow-pink: 0 0 20px rgba(255,45,120,0.3);
  --glow-cyan: 0 0 20px rgba(0,229,255,0.3);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans KR', 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-tap-highlight-color: transparent;
}

/* Animated background */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(255,45,120,0.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(0,229,255,0.06) 0%, transparent 50%),
    radial-gradient(ellipse at 50% 80%, rgba(255,200,87,0.04) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

.app { position: relative; z-index: 1; max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 100px; }

/* Header */
.header { text-align: center; padding: 24px 0 16px; }
.header h1 {
  font-family: 'Outfit', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  background: linear-gradient(135deg, var(--neon-pink), var(--neon-cyan));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  letter-spacing: -0.02em;
}
.header p { color: var(--text-dim); font-size: 0.85rem; margin-top: 4px; }

/* Navigation */
.nav-back {
  display: inline-flex; align-items: center; gap: 6px;
  color: var(--neon-cyan); font-size: 0.9rem; cursor: pointer;
  padding: 8px 0; margin-bottom: 8px; border: none; background: none;
  font-family: inherit;
}
.nav-back:hover { text-decoration: underline; }

/* Search */
.search-bar {
  display: flex; gap: 8px; margin-bottom: 20px;
}
.search-bar input {
  flex: 1; padding: 12px 16px; border-radius: 12px;
  background: var(--card); border: 1px solid var(--card-border);
  color: var(--text); font-size: 1rem; font-family: inherit;
  outline: none; transition: border-color 0.2s;
}
.search-bar input:focus { border-color: var(--neon-pink); }
.search-bar input::placeholder { color: var(--text-dim); }

/* Song Grid */
.song-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

.song-card {
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 16px; cursor: pointer;
  transition: all 0.25s ease; position: relative; overflow: hidden;
}
.song-card:hover {
  border-color: var(--neon-pink);
  box-shadow: var(--glow-pink);
  transform: translateY(-2px);
}
.song-card .album-art {
  width: 100%; aspect-ratio: 1; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem; margin-bottom: 10px;
}
.song-card .title {
  font-weight: 700; font-size: 0.9rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-card .artist {
  color: var(--text-dim); font-size: 0.78rem; margin-top: 2px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.song-card .badge {
  position: absolute; top: 8px; right: 8px;
  background: var(--neon-pink); color: #fff; font-size: 0.65rem;
  padding: 2px 6px; border-radius: 6px; font-weight: 700;
}

/* Add Song Card */
.song-card.add-card {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  border-style: dashed; min-height: 180px;
}
.song-card.add-card .plus { font-size: 2rem; color: var(--text-dim); }
.song-card.add-card .label { color: var(--text-dim); font-size: 0.85rem; margin-top: 6px; }

/* Song Detail */
.song-info {
  display: flex; gap: 16px; align-items: flex-start;
  margin-bottom: 20px; padding: 16px;
  background: var(--card); border: 1px solid var(--card-border);
  border-radius: var(--radius);
}
.song-info .art {
  width: 80px; height: 80px; border-radius: 12px; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  font-size: 2.5rem;
}
.song-info .meta { flex: 1; min-width: 0; }
.song-info .meta h2 { font-size: 1.2rem; font-weight: 800; }
.song-info .meta .artist { color: var(--text-dim); font-size: 0.9rem; }
.song-info .links { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
.song-info .links a {
  font-size: 0.75rem; padding: 3px 8px; border-radius: 8px;
  text-decoration: none; color: var(--text); font-weight: 600;
  background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12);
  transition: 0.2s;
}
.song-info .links a:hover { background: rgba(255,255,255,0.15); }

/* Toolbar */
.toolbar {
  display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap;
}
.toolbar button, .btn {
  padding: 8px 14px; border-radius: 10px; border: 1px solid var(--card-border);
  background: var(--card); color: var(--text); font-family: inherit;
  font-size: 0.82rem; cursor: pointer; transition: 0.2s; font-weight: 600;
}
.toolbar button:hover, .btn:hover {
  border-color: var(--neon-cyan); box-shadow: var(--glow-cyan);
}
.btn-primary {
  background: linear-gradient(135deg, var(--neon-pink), #ff6b9d) !important;
  border-color: var(--neon-pink) !important; color: #fff !important;
}
.btn-primary:hover { box-shadow: var(--glow-pink) !important; }
.btn-sm { padding: 6px 10px; font-size: 0.75rem; }

/* Line Editor */
.lines-container { display: flex; flex-direction: column; gap: 2px; }

.line-row {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
  border-radius: 8px; overflow: hidden; background: rgba(255,255,255,0.02);
  transition: 0.15s;
}
.line-row:hover { background: rgba(255,255,255,0.05); }
.line-row .original, .line-row .korean {
  padding: 10px 12px; font-size: 0.88rem; min-height: 42px;
  border: none; background: transparent; color: var(--text);
  font-family: inherit; outline: none; resize: none;
  line-height: 1.5;
}
.line-row .original {
  color: var(--text-dim); background: rgba(255,255,255,0.02);
  border-right: 1px solid rgba(255,255,255,0.05);
}
.line-row .korean { color: var(--neon-amber); font-weight: 700; }
.line-row .korean:focus { background: rgba(255,200,87,0.05); }
.line-row .korean::placeholder { color: rgba(255,200,87,0.3); font-weight: 400; }

.line-header {
  display: grid; grid-template-columns: 1fr 1fr; gap: 1px;
  padding: 8px 12px; font-size: 0.75rem; color: var(--text-dim);
  font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
}

/* Sections */
.section-label {
  font-size: 0.75rem; color: var(--neon-pink); font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.1em;
  margin: 16px 0 8px; padding-left: 4px;
}

/* Karaoke Mode */
.karaoke-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: #050510;
  display: none; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 24px; text-align: center;
  cursor: pointer; user-select: none;
}
.karaoke-overlay.active { display: flex; }
.karaoke-overlay .k-original {
  font-size: 1.1rem; color: var(--text-dim); margin-bottom: 16px;
  max-width: 90vw;
}
.karaoke-overlay .k-korean {
  font-size: 2.8rem; font-weight: 900; line-height: 1.3;
  color: var(--neon-amber);
  text-shadow: 0 0 40px rgba(255,200,87,0.4);
  max-width: 90vw;
  transition: opacity 0.3s;
}
.karaoke-overlay .k-progress {
  position: absolute; bottom: 40px;
  color: var(--text-dim); font-size: 0.85rem;
}
.karaoke-overlay .k-hint {
  position: absolute; bottom: 16px;
  color: rgba(255,255,255,0.2); font-size: 0.75rem;
}
.karaoke-overlay .k-close {
  position: absolute; top: 16px; right: 16px;
  font-size: 1.5rem; color: var(--text-dim);
  cursor: pointer; background: none; border: none;
  font-family: inherit;
}

/* Add/Edit Song Form */
.form-group { margin-bottom: 14px; }
.form-group label {
  display: block; font-size: 0.8rem; color: var(--text-dim);
  margin-bottom: 4px; font-weight: 600;
}
.form-group input, .form-group textarea {
  width: 100%; padding: 10px 14px; border-radius: 10px;
  background: var(--card); border: 1px solid var(--card-border);
  color: var(--text); font-family: inherit; font-size: 0.9rem;
  outline: none; transition: border-color 0.2s;
}
.form-group input:focus, .form-group textarea:focus { border-color: var(--neon-cyan); }
.form-group textarea { min-height: 120px; resize: vertical; line-height: 1.6; }

/* Options row */
.options-row {
  display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;
}
.option-chip {
  padding: 6px 12px; border-radius: 20px; font-size: 0.78rem;
  border: 1px solid var(--card-border); background: var(--card);
  color: var(--text-dim); cursor: pointer; transition: 0.2s;
  font-family: inherit; font-weight: 600;
}
.option-chip.active {
  border-color: var(--neon-cyan); color: var(--neon-cyan);
  background: rgba(0,229,255,0.1); box-shadow: var(--glow-cyan);
}

/* Export modal */
.modal-overlay {
  position: fixed; inset: 0; z-index: 900;
  background: rgba(0,0,0,0.7); display: none;
  align-items: center; justify-content: center;
  padding: 24px;
}
.modal-overlay.active { display: flex; }
.modal-box {
  background: #15152a; border: 1px solid var(--card-border);
  border-radius: var(--radius); padding: 24px;
  width: 100%; max-width: 500px; max-height: 80dvh;
  overflow-y: auto;
}
.modal-box h3 { margin-bottom: 16px; font-size: 1.1rem; }
.modal-box pre {
  background: var(--card); padding: 16px; border-radius: 10px;
  font-family: 'Noto Sans KR', monospace; font-size: 0.85rem;
  line-height: 1.8; white-space: pre-wrap; word-break: break-all;
  color: var(--neon-amber); max-height: 50dvh; overflow-y: auto;
}
.modal-actions { display: flex; gap: 8px; margin-top: 16px; }

/* AI Loading */
.ai-loading {
  text-align: center; padding: 32px;
  color: var(--neon-cyan); font-size: 0.9rem;
}
.ai-loading .spinner {
  width: 32px; height: 32px; border: 3px solid rgba(0,229,255,0.2);
  border-top-color: var(--neon-cyan); border-radius: 50%;
  animation: spin 0.8s linear infinite; margin: 0 auto 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Toast */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: var(--neon-cyan); color: #000; font-weight: 700;
  padding: 10px 20px; border-radius: 10px; font-size: 0.85rem;
  z-index: 2000; opacity: 0; transition: opacity 0.3s;
  pointer-events: none;
}
.toast.show { opacity: 1; }

/* Responsive */
@media (max-width: 400px) {
  .song-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
  .song-card { padding: 12px; }
  .song-card .album-art { font-size: 2rem; }
  .karaoke-overlay .k-korean { font-size: 2rem; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

/* Fade transition */
.view { animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="app" id="app"></div>
<div class="karaoke-overlay" id="karaoke"></div>
<div class="modal-overlay" id="exportModal"></div>
<div class="toast" id="toast"></div>

<script>
const LLM_URL = 'https://llm.cocy.io/v2/chat/completions';
const LLM_KEY = 'choon150622';

const SAMPLE_SONGS = [
  {
    id: 's1', title: 'Shape of You', artist: 'Ed Sheeran', emoji: 'ğŸŸ§',
    gradient: 'linear-gradient(135deg,#ff6b35,#ff2d78)',
    links: { youtube: 'https://www.youtube.com/watch?v=JGwWNGJdvx8', spotify: 'https://open.spotify.com/track/7qiZfU4dY1lWllzX7mPBI3' },
    lines: [
      { original: "The club isn't the best place to find a lover", korean: 'ë” í´ëŸ½ ì´ì „ ë” ë² ìŠ¤íŠ¸ í”Œë ˆì´ìŠ¤ íˆ¬ íŒŒì¸ë‹¤ ëŸ¬ë²„' },
      { original: "So the bar is where I go", korean: 'ì˜ ë” ë°” ì´ì¦ˆ ì›¨ì–´ ì•„ì´ ê³ ' },
      { original: "Me and my friends at the table doing shots", korean: 'ë¯¸ ì•¤ ë§ˆì´ í”„ë Œì¦ˆ ì•³ ë” í…Œì´ë¸” ë‘ì‰ ìƒ·ì¸ ' },
      { original: "Drinking fast and then we talk slow", korean: 'ë“œë§í‚¹ íŒ¨ìŠ¤íŠ¸ ì•¤ ë´ ìœ„ í†¡ ìŠ¬ë¡œìš°' },
      { original: "I'm in love with the shape of you", korean: 'ì•„ì„ ì¸ ëŸ¬ë¸Œ ìœ‹ ë” ì…°ì ì˜¤ë¸Œ ìœ ' },
      { original: "We push and pull like a magnet do", korean: 'ìœ„ í‘¸ì‰¬ ì•¤ í’€ ë¼ì´ì¹´ ë§ˆê·¸ë„· ë‘' },
      { original: "Although my heart is falling too", korean: 'ì˜¬ë„ ë§ˆì´ í•˜íŠ¸ ì´ì¦ˆ í´ë§ íˆ¬' },
      { original: "I'm in love with your body", korean: 'ì•„ì„ ì¸ ëŸ¬ë¸Œ ìœ‹ ìœ ì–´ ë°”ë””' },
    ]
  },
  {
    id: 's2', title: 'Blinding Lights', artist: 'The Weeknd', emoji: 'ğŸŒƒ',
    gradient: 'linear-gradient(135deg,#e01f4f,#ff6b35)',
    links: { youtube: 'https://www.youtube.com/watch?v=4NRXx6U8ABQ', spotify: 'https://open.spotify.com/track/0VjIjW4GlUZAMYd2vXMi3b' },
    lines: [
      { original: "I've been tryna call", korean: 'ì•„ì´ë¸Œ ë¹ˆ íŠ¸ë¼ì´ë‚˜ ì½œ' },
      { original: "I've been on my own for long enough", korean: 'ì•„ì´ë¸Œ ë¹ˆ ì˜¨ ë§ˆì´ ì˜¤ìš´ í¬ ë¡± ì´ë„ˆí”„' },
      { original: "Maybe you can show me how to love, maybe", korean: 'ë©”ì´ë¹„ ìœ  ìº” ì‡¼ ë¯¸ í•˜ìš° íˆ¬ ëŸ¬ë¸Œ ë©”ì´ë¹„' },
      { original: "I'm going through withdrawals", korean: 'ì•„ì„ ê³ ì‰ ì“°ë£¨ ìœ„ë“œë¡œì–¼ì¦ˆ' },
      { original: "I said ooh, I'm blinding lights", korean: 'ì•„ì´ ì„¸ë“œ ìš°~ ì•„ì„ ë¸”ë¼ì¸ë”© ë¼ì´ì¸ ' },
      { original: "No I can't sleep until I feel your touch", korean: 'ë…¸ ì•„ì´ ìº” ìŠ¬ë¦½ ì–¸í‹¸ ì•„ì´ í•„ ìœ ì–´ í„°ì¹˜' },
    ]
  },
  {
    id: 's3', title: 'Someone Like You', artist: 'Adele', emoji: 'ğŸ’§',
    gradient: 'linear-gradient(135deg,#4a90d9,#1a1a3e)',
    links: { youtube: 'https://www.youtube.com/watch?v=hLQl3WQQoQ0', spotify: 'https://open.spotify.com/track/1zwMYTA5nlNjZxYrvBB2pV' },
    lines: [
      { original: "I heard that you're settled down", korean: 'ì•„ì´ í—ˆë“œ ëŒ“ ìœ ì–´ ì„¸í‹€ë“œ ë‹¤ìš´' },
      { original: "That you found a girl and you're married now", korean: 'ëŒ“ ìœ  íŒŒìš´ë‹¤ ê±¸ ì•¤ ìœ ì–´ ë§¤ë¦¬ë“œ ë‚˜ìš°' },
      { original: "Never mind, I'll find someone like you", korean: 'ë„¤ë²„ë§ˆì¸ë“œ ì•„ì¼ íŒŒì¸ë“œ ì¸ì› ë¼ì´í¬ ìœ ~' },
      { original: "I wish nothing but the best for you, too", korean: 'ì•„ì´ ìœ„ì‰¬ ë‚«ëµ ë²— ë” ë² ìŠ¤íŠ¸ í¬ ìœ  íˆ¬' },
      { original: "Don't forget me, I beg", korean: 'ëˆ í¬ê²Ÿ ë¯¸ ì•„ì´ ë²¡' },
      { original: "I remember you said", korean: 'ì•„ì´ ë¦¬ë©¤ë²„ ìœ  ì„¸ë“œ' },
      { original: "Sometimes it lasts in love but sometimes it hurts instead", korean: 'ì¸íƒ€ì„ì¦ˆ ì‡ ë˜ìŠ¤ì¸  ì¸ ëŸ¬ë¸Œ ë²— ì¸íƒ€ì„ì¦ˆ ì‡ í—ˆì¸  ì¸ìŠ¤í…Œë“œ' },
    ]
  },
  {
    id: 's4', title: 'Bohemian Rhapsody', artist: 'Queen', emoji: 'ğŸ‘‘',
    gradient: 'linear-gradient(135deg,#ffd700,#8b0000)',
    links: { youtube: 'https://www.youtube.com/watch?v=fJ9rUzIMcZQ', spotify: 'https://open.spotify.com/track/7tFiyTwD0nx5a1eklYtX2J' },
    lines: [
      { original: "Is this the real life? Is this just fantasy?", korean: 'ì´ì¦ˆ ë””ìŠ¤ ë” ë¦¬ì–¼ ë¼ì´í”„? ì´ì¦ˆ ë””ìŠ¤ ì €ìŠ¤íŠ¸ íŒíƒ€ì§€?' },
      { original: "Caught in a landslide, no escape from reality", korean: 'ì½§ ì¸ ì–´ ëœë“œìŠ¬ë¼ì´ë“œ ë…¸ ì´ìŠ¤ì¼€ì´í”„ í”„ë¡¬ ë¦¬ì–¼ë¦¬í‹°' },
      { original: "Open your eyes, look up to the skies and see", korean: 'ì˜¤í”ˆ ìœ ì–´ ì•„ì´ì¦ˆ ë£© ì—… íˆ¬ ë” ìŠ¤ì¹´ì´ì¦ˆ ì•¤ ì”¨' },
      { original: "I'm just a poor boy, I need no sympathy", korean: 'ì•„ì„ ì €ìŠ¤íŠ¸ ì–´ í‘¸ì–´ ë³´ì´ ì•„ì´ ë‹ˆë“œ ë…¸ ì‹¬í¼ì‹œ' },
      { original: "Easy come, easy go, little high, little low", korean: 'ì´ì§€ ì»´ ì´ì§€ ê³  ë¦¬í‹€ í•˜ì´ ë¦¬í‹€ ë¡œìš°' },
      { original: "Mama, just killed a man", korean: 'ë§ˆë§ˆ~ ì €ìŠ¤íŠ¸ í‚¬ë“œ ì–´ ë§¨' },
      { original: "Put a gun against his head, pulled my trigger now he's dead", korean: 'í’‹ ì–´ ê±´ ì–´ê²ìŠ¤íŠ¸ íˆì¦ˆ í—¤ë“œ í’€ë“œ ë§ˆì´ íŠ¸ë¦¬ê±° ë‚˜ìš° íˆì¦ˆ ë°ë“œ' },
    ]
  },
  {
    id: 's5', title: 'Yesterday', artist: 'The Beatles', emoji: 'ğŸ¸',
    gradient: 'linear-gradient(135deg,#8b6914,#2d1810)',
    links: { youtube: 'https://www.youtube.com/watch?v=NrgmdOz227I', spotify: 'https://open.spotify.com/track/3BQHpFgAp4l80e1XslIjNI' },
    lines: [
      { original: "Yesterday, all my troubles seemed so far away", korean: 'ì˜ˆìŠ¤í„°ë°ì´ ì˜¬ ë§ˆì´ íŠ¸ëŸ¬ë¸”ìŠ¤ ì‹¬ë“œ ì˜ íŒŒ ì–´ì›¨ì´' },
      { original: "Now it looks as though they're here to stay", korean: 'ë‚˜ìš° ì‡ ë£©ìŠ¤ ì• ì¦ˆ ë„ ë°ì–´ íˆì–´ íˆ¬ ìŠ¤í…Œì´' },
      { original: "Oh, I believe in yesterday", korean: 'ì˜¤~ ì•„ì´ ë¹Œë¦¬ë¸Œ ì¸ ì˜ˆìŠ¤í„°ë°ì´' },
      { original: "Suddenly, I'm not half the man I used to be", korean: 'ì„œë“ ë¦¬ ì•„ì„ ë‚« í•´í”„ ë” ë§¨ ì•„ì´ ìœ ì¦ˆë“œ íˆ¬ ë¹„' },
      { original: "There's a shadow hanging over me", korean: 'ë°ì–´ì¦ˆ ì–´ ì„€ë„ìš° í–‰ì‰ ì˜¤ë²„ ë¯¸' },
      { original: "Oh, yesterday came suddenly", korean: 'ì˜¤~ ì˜ˆìŠ¤í„°ë°ì´ ì¼€ì„ ì„œë“ ë¦¬' },
    ]
  },
  {
    id: 's6', title: 'Hotel California', artist: 'Eagles', emoji: 'ğŸ¨',
    gradient: 'linear-gradient(135deg,#ff8c42,#1a0a2e)',
    links: { youtube: 'https://www.youtube.com/watch?v=09839DpTctU', spotify: 'https://open.spotify.com/track/40riOy7x9W7GXjyGp4pjAv' },
    lines: [
      { original: "On a dark desert highway, cool wind in my hair", korean: 'ì˜¨ ì–´ ë‹¤í¬ ë°ì €íŠ¸ í•˜ì´ì›¨ì´ ì¿¨ ìœˆë“œ ì¸ ë§ˆì´ í—¤ì–´' },
      { original: "Warm smell of colitas rising up through the air", korean: 'ì›œ ìŠ¤ë©œ ì˜¤ë¸Œ ì½œë¦¬íƒ€ìŠ¤ ë¼ì´ì§• ì—… ì“°ë£¨ ë”” ì—ì–´' },
      { original: "Welcome to the Hotel California", korean: 'ì›°ì»´ íˆ¬ ë” í˜¸í…” ìº˜ë¦¬í¬ë‹ˆì•„~' },
      { original: "Such a lovely place, such a lovely face", korean: 'ì„œì¹˜ ì–´ ëŸ¬ë¸”ë¦¬ í”Œë ˆì´ìŠ¤ ì„œì¹˜ ì–´ ëŸ¬ë¸”ë¦¬ í˜ì´ìŠ¤' },
      { original: "You can check out any time you like", korean: 'ìœ  ìº” ì²´í¬ ì•„ì›ƒ ì• ë‹ˆ íƒ€ì„ ìœ  ë¼ì´í¬' },
      { original: "But you can never leave", korean: 'ë²— ìœ  ìº” ë„¤ë²„ ë¦¬ë¸Œ~' },
    ]
  },
  {
    id: 's7', title: "Don't Stop Believin'", artist: 'Journey', emoji: 'ğŸš‚',
    gradient: 'linear-gradient(135deg,#4169e1,#ff6347)',
    links: { youtube: 'https://www.youtube.com/watch?v=1k8craCGpgs', spotify: 'https://open.spotify.com/track/4bHsxqR3GMrXTxEPLuK5ue' },
    lines: [
      { original: "Just a small town girl, livin' in a lonely world", korean: 'ì €ìŠ¤íŠ¸ ì–´ ìŠ¤ëª° íƒ€ìš´ ê±¸ ë¦¬ë¹ˆ ì¸ ì–´ ë¡ ë¦¬ ì›”ë“œ' },
      { original: "She took the midnight train goin' anywhere", korean: 'ì‰¬ íˆ­ ë” ë¯¸ë“œë‚˜ì‡ íŠ¸ë ˆì¸ ê³ ì‰ ì• ë‹ˆì›¨ì–´' },
      { original: "Just a city boy, born and raised in South Detroit", korean: 'ì €ìŠ¤íŠ¸ ì–´ ì‹œí‹° ë³´ì´ ë³¸ ì•¤ ë ˆì´ì¦ˆë“œ ì¸ ì‚¬ìš°ìŠ¤ ë””íŠ¸ë¡œì‡' },
      { original: "Strangers waiting up and down the boulevard", korean: 'ìŠ¤íŠ¸ë ˆì¸ì €ìŠ¤ ì›¨ì´íŒ… ì—… ì•¤ ë‹¤ìš´ ë” ë¶ˆëŸ¬ë°”ë“œ' },
      { original: "Don't stop believin', hold on to that feelin'", korean: 'ëˆ ìŠ¤íƒ‘ ë¹Œë¦¬ë¹ˆ~ í™€ë“œ ì˜¨ íˆ¬ ëŒ“ í•„ë§~' },
    ]
  },
  {
    id: 's8', title: 'Rolling in the Deep', artist: 'Adele', emoji: 'ğŸ”¥',
    gradient: 'linear-gradient(135deg,#c0392b,#2c3e50)',
    links: { youtube: 'https://www.youtube.com/watch?v=rYEDA3JcQqw', spotify: 'https://open.spotify.com/track/1c8gk2PeTE04A1pIDH9YMk' },
    lines: [
      { original: "There's a fire starting in my heart", korean: 'ë°ì–´ì¦ˆ ì–´ íŒŒì´ì–´ ìŠ¤íƒ€íŒ… ì¸ ë§ˆì´ í•˜íŠ¸' },
      { original: "Reaching a fever pitch and it's bringing me out the dark", korean: 'ë¦¬ì¹­ ì–´ í”¼ë²„ í”¼ì¹˜ ì•¤ ì‡ì¸  ë¸Œë§ì‰ ë¯¸ ì•„ì›ƒ ë” ë‹¤í¬' },
      { original: "We could have had it all", korean: 'ìœ„ ì¿ ë“œ í•´ë¸Œ í•´ë“œ ì‡ ì˜¬~' },
      { original: "Rolling in the deep", korean: 'ë¡¤ë§ ì¸ ë” ë”¥~' },
      { original: "You had my heart inside of your hands", korean: 'ìœ  í•´ë“œ ë§ˆì´ í•˜íŠ¸ ì¸ì‚¬ì´ë“œ ì˜¤ë¸Œ ìœ ì–´ í•¸ì¦ˆ' },
      { original: "And you played it to the beat", korean: 'ì•¤ ìœ  í”Œë ˆì´ë“œ ì‡ íˆ¬ ë” ë¹—' },
    ]
  },
  {
    id: 's9', title: 'Uptown Funk', artist: 'Bruno Mars', emoji: 'ğŸ•º',
    gradient: 'linear-gradient(135deg,#ff1744,#ffc107)',
    links: { youtube: 'https://www.youtube.com/watch?v=OPf0YbXqDm0', spotify: 'https://open.spotify.com/track/32OlwWuMpZ6b0aN2RZOeMS' },
    lines: [
      { original: "This hit, that ice cold, Michelle Pfeiffer, that white gold", korean: 'ë””ìŠ¤ í› ëŒ“ ì•„ì´ìŠ¤ ì½œë“œ ë¯¸ì…¸ íŒŒì´í¼ ëŒ“ í™”ì´íŠ¸ ê³¨ë“œ' },
      { original: "Don't believe me, just watch", korean: 'ëˆ ë¹Œë¦¬ë¸Œ ë¯¸ ì €ìŠ¤íŠ¸ ì›Œì¹˜!' },
      { original: "Uptown funk you up, uptown funk you up", korean: 'ì—…íƒ€ìš´ í‘í¬ ìœ  ì—…! ì—…íƒ€ìš´ í‘í¬ ìœ  ì—…!' },
      { original: "Saturday night and we in the spot", korean: 'ìƒˆí„°ë°ì´ ë‚˜ì‡ ì•¤ ìœ„ ì¸ ë” ìŠ¤íŒŸ' },
      { original: "Girls hit your hallelujah", korean: 'ê±¸ìŠ¤ í› ìœ ì–´ í• ë ë£¨ì•¼~' },
      { original: "Cause uptown funk gon' give it to you", korean: 'ì»¤ì¦ˆ ì—…íƒ€ìš´ í‘í¬ ê³¤ ê¸°ë¹— íˆ¬ ìœ ' },
    ]
  },
  {
    id: 's10', title: 'Dynamite', artist: 'BTS', emoji: 'ğŸ§¨',
    gradient: 'linear-gradient(135deg,#7b1fa2,#ff6f00)',
    links: { youtube: 'https://www.youtube.com/watch?v=gdZLi9oWNZg', spotify: 'https://open.spotify.com/track/5QDLhrAOJJdNAmCTJ8xMyW' },
    lines: [
      { original: "Cause I, I, I'm in the stars tonight", korean: 'ì»¤ì¦ˆ ì•„ì´ ì•„ì´ ì•„ì´ ì•„ì„ ì¸ ë” ìŠ¤íƒ€ì¦ˆ íˆ¬ë‚˜ì‡' },
      { original: "So watch me bring the fire and set the night alight", korean: 'ì˜ ì›Œì¹˜ ë¯¸ ë¸Œë§ ë” íŒŒì´ì–´ ì•¤ ì…‹ ë” ë‚˜ì‡ ì–¼ë¼ì‡' },
      { original: "Shining through the city with a little funk and soul", korean: 'ìƒ¤ì´ë‹ ì“°ë£¨ ë” ì‹œí‹° ìœ‹ ì–´ ë¦¬í‹€ í‘í¬ ì•¤ ì†Œìš¸' },
      { original: "So I'ma light it up like dynamite", korean: 'ì˜ ì•„ì´ë§ˆ ë¼ì‡ ì‡ ì—… ë¼ì´í¬ ë‹¤ì´ë„ˆë§ˆì´íŠ¸!' },
      { original: "Dy-na-na-na-na-na-na-na-na-na, life is dynamite", korean: 'ë‹¤ì´ ë‚˜ë‚˜ë‚˜ë‚˜ë‚˜ë‚˜ ë‚˜ë‚˜ë‚˜ ë¼ì´í”„ ì´ì¦ˆ ë‹¤ì´ë„ˆë§ˆì´íŠ¸!' },
      { original: "Bring a friend, join the crowd, whoever wanna come along", korean: 'ë¸Œë§ ì–´ í”„ë Œë“œ ì¡°ì¸ ë” í¬ë¼ìš°ë“œ í›„ì—ë²„ ì›Œë‚˜ ì»´ ì–¼ë¡±' },
    ]
  },
  {
    id: 's11', title: 'Despacito', artist: 'Luis Fonsi ft. Daddy Yankee', emoji: 'ğŸŒ´',
    gradient: 'linear-gradient(135deg,#ff6b35,#ffce00)',
    links: { youtube: 'https://www.youtube.com/watch?v=kJQP7kiw5Fk', spotify: 'https://open.spotify.com/track/6habFhsOp2NvshLv26DqMb' },
    lines: [
      { original: 'Despacito, quiero respirar tu cuello despacito', korean: 'ë°ìŠ¤íŒŒì‹œë˜~ ë¼ì—ë¡œ ë ˆìŠ¤í”¼ë¼ë¥´ ëšœ ê¾¸ì—ìš” ë°ìŠ¤íŒŒì‹œë˜' },
      { original: 'Deja que te diga cosas al oÃ­do', korean: 'ë°í•˜ ê²Œ ë–¼ ë””ê°€ ê¼¬ì‚¬ìŠ¤ ì•Œ ì˜¤ì´ë„' },
      { original: 'Para que te acuerdes si no estÃ¡s conmigo', korean: 'ë¹ ë¼ ê²Œ ë–¼ ì•„ê¾¸ì—ë¥´ë°ìŠ¤ ì‹œ ë…¸ ì—ìŠ¤ë”°ìŠ¤ ê¼°ë¯¸ê³ ' },
      { original: 'Despacito, quiero desnudarte a besos despacito', korean: 'ë°ìŠ¤íŒŒì‹œë˜~ ë¼ì—ë¡œ ë°ìŠ¤ëˆ„ë‹¤ë¥´ë–¼ ì•„ ë² ì†ŒìŠ¤ ë°ìŠ¤íŒŒì‹œë˜' },
      { original: 'Firmo en las paredes de tu laberinto', korean: 'í”¼ë¥´ëª¨ ì—” ë¼ìŠ¤ ë¹ ë ˆë°ìŠ¤ ë° ëšœ ë¼ë² ë¦°ë˜' },
      { original: 'Y hacer de tu cuerpo todo un manuscrito', korean: 'ì´ ì•„ì„¸ë¥´ ë° ëšœ ê¾¸ì—ë¥´ë½€ ë˜ë„ ìš´ ë§ˆëˆ„ìŠ¤ë„ë¦¬ë˜' },
      { original: 'Sube, sube, sube, sube, sube', korean: 'ìˆ˜ë²  ìˆ˜ë²  ìˆ˜ë²  ìˆ˜ë²  ìˆ˜ë² ~' },
      { original: 'Pasito a pasito, suave suavecito', korean: 'ë¹ ì‹œë˜ ì•„ ë¹ ì‹œë˜~ ìˆ˜ì•„ë²  ìˆ˜ì•„ë² ì‹œë˜~' },
      { original: "Nos vamos pegando poquito a poquito", korean: 'ë…¸ìŠ¤ ë°”ëª¨ìŠ¤ ë»¬ê°„ë„ ë½€ë¼ë˜ ì•„ ë½€ë¼ë˜' },
    ]
  },
  {
    id: 's12', title: 'First Love (åˆæ‹)', artist: 'å®‡å¤šç”°ãƒ’ã‚«ãƒ« (Utada Hikaru)', emoji: 'ğŸŒ¸',
    gradient: 'linear-gradient(135deg,#f8b4c8,#6a0dad)',
    links: { youtube: 'https://www.youtube.com/watch?v=o1sUaVJUeB0', spotify: 'https://open.spotify.com/track/7nYOFJyqFYMJ0xjBfEaJNz' },
    lines: [
      { original: 'æœ€å¾Œã®ã‚­ã‚¹ã¯ã‚¿ãƒã‚³ã® flavor ãŒã—ãŸ', korean: 'ì‚¬ì´ê³ ë…¸ í‚¤ìŠ¤ì™€ íƒ€ë°”ì½”ë…¸ í›„ë ˆì´ë°”ê°€ ì‹œíƒ€' },
      { original: 'ãƒ‹ã‚¬ãã¦åˆ‡ãªã„é¦™ã‚Š', korean: 'ë‹ˆê°€ì¿ í…Œ ì„¸ì¸ ë‚˜ì´ ì¹´ì˜¤ë¦¬' },
      { original: 'æ˜æ—¥ã®ä»Šé ƒã«ã¯', korean: 'ì•„ì‹œíƒ€ë…¸ ì´ë§ˆê³ ë¡œë‹ˆì™€' },
      { original: 'ã‚ãªãŸã¯ã©ã“ã«ã„ã‚‹ã‚“ã ã‚ã†', korean: 'ì•„ë‚˜íƒ€ì™€ ë„ì½”ë‹ˆ ì´ë£¬ë‹¤ë¡œ~' },
      { original: 'èª°ã‚’æƒ³ã£ã¦ã‚‹ã‚“ã ã‚ã†', korean: 'ë‹¤ë ˆì˜¤ ì˜¤ëª»í…Œë£¬ë‹¤ë¡œ~' },
      { original: 'You are always gonna be my love', korean: 'ìœ  ì•„ ì˜¬ì›¨ì´ì¦ˆ ê³ ë‚˜ ë¹„ ë§ˆì´ ëŸ¬ë¸Œ' },
      { original: 'ã„ã¤ã‹èª°ã‹ã¨ã¾ãŸæ‹ã«è½ã¡ã¦ã‚‚', korean: 'ì´ì¸ ì¹´ ë‹¤ë ˆì¹´í†  ë§ˆíƒ€ ì½”ì´ë‹ˆ ì˜¤ì¹˜í…Œëª¨' },
      { original: "I'll remember to love, you taught me how", korean: 'ì•„ì¼ ë¦¬ë©¤ë²„ íˆ¬ ëŸ¬ë¸Œ ìœ  í†³ ë¯¸ í•˜ìš°' },
      { original: 'You are always gonna be the one', korean: 'ìœ  ì•„ ì˜¬ì›¨ì´ì¦ˆ ê³ ë‚˜ ë¹„ ë” ì›' },
      { original: 'ä»Šã¯ã¾ã æ‚²ã—ã„ love song', korean: 'ì´ë§ˆì™€ ë§ˆë‹¤ ì¹´ë‚˜ì‹œì´ ëŸ¬ë¸Œ ì­~' },
      { original: 'æ–°ã—ã„æ­Œ æ­Œãˆã‚‹ã¾ã§', korean: 'ì•„íƒ€ë¼ì‹œì´ ìš°íƒ€ ìš°íƒ€ì—ë£¨ ë§ˆë°' },
    ]
  },
  {
    id: 's13', title: 'ä»–è¯´ (TÄ ShuÅ)', artist: 'JJ Lin (æ—ä¿Šæ°)', emoji: 'ğŸ®',
    gradient: 'linear-gradient(135deg,#c0392b,#f1c40f)',
    links: { youtube: 'https://www.youtube.com/watch?v=IaI5JCxOCdw', spotify: 'https://open.spotify.com/track/4VqxfGHMVeVBFnPC76tqaA' },
    lines: [
      { original: 'ä»–è¯´ä½ ä»»æ€§ ä½ è‡ªç§', korean: 'íƒ€ ìŠˆì˜¤ ë‹ˆ ëŸ°ì‹± ë‹ˆ ì¯”ì“°' },
      { original: 'ç›¸çˆ±æ€»æ˜¯é‚£ä¹ˆä¸å®¹æ˜“', korean: 'ì‹œì•™ì•„ì´ ì«‘ìŠ¤ ë‚˜ë¨¸ ë¶€ë¡±ì´' },
      { original: 'æ¯ä¸ªäººæœ‰ä»–çš„è„¾æ°”', korean: 'ë©”ì´ê±° ëŸ° ìš”ìš° íƒ€ë” í”¼ì¹˜' },
      { original: 'è¿‡äº†çˆ±åšæ¢¦çš„å¹´çºª', korean: 'ê¿”ëŸ¬ ì•„ì´ ì­¤ë©ë” ë‹ˆì—”ì§€' },
      { original: 'è½°è½°çƒˆçƒˆä¸å¦‚å¹³é™', korean: 'í™í™ë¦¬ì—ë¦¬ì— ë¶€ë£¨ í•‘ì§•' },
      { original: 'å¹¸ç¦æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“', korean: 'ì‹±í‘¸ ë©”ì´ìš”ìš° ë‚˜ë¨¸ ë¡±ì´' },
      { original: 'æ‰ä¼šç‰¹åˆ«è®©äººç€è¿·', korean: 'ì°¨ì´ í›„ì´ í„°ë¹„ì— ë‘ëŸ° ìì˜¤ë¯¸' },
      { original: 'ä»€ä¹ˆéƒ½ä¸æ‡‚çš„å¹´çºª', korean: 'ì…˜ë¨¸ ë„ìš° ë¶€ë™ë” ë‹ˆì—”ì§€' },
      { original: 'æ›¾ç»æœ€æå¿ƒ å´è¢«å«Œå¤ªå¤©çœŸ', korean: 'ì©¡ì§• ì­¤ì´ íƒ€ì˜¤ì‹  ì·¨ì— ë² ì´ì‹œì—” íƒ€ì´ í‹°ì—”ì „' },
    ]
  },
];

// --- State ---
let state = {
  view: 'home', // home | editor | add
  songs: [],
  currentSongId: null,
  search: '',
  karaokeIndex: 0,
  aiOptions: { stretch: false, stress: false, rhyme: false },
};

function loadState() {
  const saved = localStorage.getItem('feellyrics_songs');
  if (saved) {
    state.songs = JSON.parse(saved);
  } else {
    state.songs = JSON.parse(JSON.stringify(SAMPLE_SONGS));
    saveState();
  }
}

function saveState() {
  localStorage.setItem('feellyrics_songs', JSON.stringify(state.songs));
}

function getCurrentSong() {
  return state.songs.find(s => s.id === state.currentSongId);
}

// --- Toast ---
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2000);
}

// --- Render ---
function render() {
  const app = document.getElementById('app');
  switch(state.view) {
    case 'home': app.innerHTML = renderHome(); break;
    case 'editor': app.innerHTML = renderEditor(); break;
    case 'add': app.innerHTML = renderAddForm(); break;
  }
  bindEvents();
}

function renderHome() {
  const filtered = state.songs.filter(s =>
    !state.search || s.title.toLowerCase().includes(state.search.toLowerCase()) ||
    s.artist.toLowerCase().includes(state.search.toLowerCase())
  );
  return `
    <div class="view">
      <div class="header">
        <h1>ğŸ¤ ëŠë‚Œê°€ì‚¬</h1>
        <p>ì™¸êµ­ ë…¸ë˜ë¥¼ í•œê¸€ ë°œìŒìœ¼ë¡œ ë”°ë¼ ë¶€ë¥´ì</p>
      </div>
      <div class="search-bar">
        <input type="text" placeholder="ê³¡ ë˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." value="${escHtml(state.search)}" id="searchInput">
      </div>
      <div class="song-grid">
        ${filtered.map(s => `
          <div class="song-card" data-action="open" data-id="${s.id}">
            <div class="album-art" style="background:${s.gradient}">${s.emoji}</div>
            <div class="title">${escHtml(s.title)}</div>
            <div class="artist">${escHtml(s.artist)}</div>
            ${s.id.startsWith('s') ? '<span class="badge">SAMPLE</span>' : ''}
          </div>
        `).join('')}
        <div class="song-card add-card" data-action="add">
          <div class="plus">+</div>
          <div class="label">ìƒˆ ê³¡ ë“±ë¡</div>
        </div>
      </div>
    </div>
  `;
}

function renderEditor() {
  const song = getCurrentSong();
  if (!song) { state.view = 'home'; return renderHome(); }
  const linkLabels = { youtube: 'â–¶ YouTube', spotify: 'ğŸµ Spotify', melon: 'ğŸˆ Melon' };
  return `
    <div class="view">
      <button class="nav-back" data-action="back">â† ëª©ë¡ìœ¼ë¡œ</button>
      <div class="song-info">
        <div class="art" style="background:${song.gradient}">${song.emoji}</div>
        <div class="meta">
          <h2>${escHtml(song.title)}</h2>
          <div class="artist">${escHtml(song.artist)}</div>
          <div class="links">
            ${Object.entries(song.links||{}).map(([k,v]) => v ? `<a href="${escHtml(v)}" target="_blank" rel="noopener">${linkLabels[k]||k}</a>` : '').join('')}
          </div>
        </div>
      </div>

      <div class="section-label">ğŸ¤– AI ëŠë‚Œê°€ì‚¬ ìƒì„±</div>
      <div class="options-row">
        <button class="option-chip ${state.aiOptions.stretch?'active':''}" data-option="stretch">ğŸµ ìŒì ˆ ëŠ˜ë¦¬ê¸°</button>
        <button class="option-chip ${state.aiOptions.stress?'active':''}" data-option="stress">ğŸ’ª ê°•ì„¸ ê°•ì¡°</button>
        <button class="option-chip ${state.aiOptions.rhyme?'active':''}" data-option="rhyme">ğŸ¶ ë¼ì„ ëŠë‚Œ</button>
      </div>
      <div class="toolbar">
        <button class="btn btn-primary" data-action="aiGenerate">âœ¨ AI ìƒì„±</button>
        <button class="btn" data-action="karaoke">ğŸ¤ ë…¸ë˜ë°©</button>
        <button class="btn" data-action="addLine">+ ì¤„ ì¶”ê°€</button>
        <button class="btn" data-action="export">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
        ${!song.id.startsWith('s') ? '<button class="btn" data-action="deleteSong" style="color:#ff4444">ğŸ—‘</button>' : ''}
      </div>

      <div id="aiStatus"></div>

      <div class="line-header"><span>ì›ë¬¸ ê°€ì‚¬</span><span>í•œê¸€ ëŠë‚Œê°€ì‚¬</span></div>
      <div class="lines-container" id="linesContainer">
        ${song.lines.map((l, i) => `
          <div class="line-row" data-idx="${i}">
            <textarea class="original" rows="1" data-field="original" data-idx="${i}">${escHtml(l.original)}</textarea>
            <textarea class="korean" rows="1" placeholder="í•œê¸€ ë°œìŒ ì…ë ¥..." data-field="korean" data-idx="${i}">${escHtml(l.korean)}</textarea>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function renderAddForm() {
  return `
    <div class="view">
      <button class="nav-back" data-action="back">â† ëª©ë¡ìœ¼ë¡œ</button>
      <div class="header" style="padding-bottom:8px"><h1>ğŸµ ìƒˆ ê³¡ ë“±ë¡</h1></div>
      <div class="form-group">
        <label>ê³¡ ì œëª© *</label>
        <input id="addTitle" placeholder="Shape of You">
      </div>
      <div class="form-group">
        <label>ì•„í‹°ìŠ¤íŠ¸ *</label>
        <input id="addArtist" placeholder="Ed Sheeran">
      </div>
      <div class="form-group">
        <label>YouTube ë§í¬</label>
        <input id="addYoutube" placeholder="https://www.youtube.com/watch?v=...">
      </div>
      <div class="form-group">
        <label>Spotify ë§í¬</label>
        <input id="addSpotify" placeholder="https://open.spotify.com/track/...">
      </div>
      <div class="form-group">
        <label>ê°€ì‚¬ (í•œ ì¤„ì— í•˜ë‚˜ì”©)</label>
        <textarea id="addLyrics" placeholder="Is this the real life?&#10;Is this just fantasy?&#10;Caught in a landslide..."></textarea>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn btn-primary" data-action="saveSong" style="flex:1">ë“±ë¡í•˜ê¸°</button>
        <button class="btn" data-action="back">ì·¨ì†Œ</button>
      </div>
    </div>
  `;
}

// --- Events ---
function bindEvents() {
  const app = document.getElementById('app');

  // Search
  const si = document.getElementById('searchInput');
  if (si) si.addEventListener('input', e => { state.search = e.target.value; render(); });

  // Click delegation
  app.addEventListener('click', handleClick);

  // Textarea auto-resize + save
  app.querySelectorAll('textarea[data-field]').forEach(ta => {
    autoResize(ta);
    ta.addEventListener('input', e => {
      autoResize(e.target);
      const song = getCurrentSong();
      if (!song) return;
      const idx = +e.target.dataset.idx;
      const field = e.target.dataset.field;
      song.lines[idx][field] = e.target.value;
      saveState();
    });
  });

  // Option chips
  app.querySelectorAll('.option-chip').forEach(el => {
    el.addEventListener('click', () => {
      const opt = el.dataset.option;
      state.aiOptions[opt] = !state.aiOptions[opt];
      el.classList.toggle('active');
    });
  });
}

function handleClick(e) {
  const btn = e.target.closest('[data-action]');
  if (!btn) return;
  const action = btn.dataset.action;

  switch(action) {
    case 'open':
      state.currentSongId = btn.dataset.id;
      state.view = 'editor';
      render();
      break;
    case 'back':
      state.view = 'home';
      render();
      break;
    case 'add':
      state.view = 'add';
      render();
      break;
    case 'karaoke':
      openKaraoke();
      break;
    case 'aiGenerate':
      aiGenerate();
      break;
    case 'addLine':
      addLine();
      break;
    case 'export':
      openExport();
      break;
    case 'saveSong':
      saveSong();
      break;
    case 'deleteSong':
      deleteSong();
      break;
  }
}

function autoResize(ta) {
  ta.style.height = 'auto';
  ta.style.height = ta.scrollHeight + 'px';
}

// --- Actions ---
function addLine() {
  const song = getCurrentSong();
  if (!song) return;
  song.lines.push({ original: '', korean: '' });
  saveState();
  render();
  // Focus last korean input
  setTimeout(() => {
    const all = document.querySelectorAll('.korean');
    if (all.length) all[all.length-1].focus();
  }, 50);
}

function saveSong() {
  const title = document.getElementById('addTitle').value.trim();
  const artist = document.getElementById('addArtist').value.trim();
  if (!title || !artist) { toast('ì œëª©ê³¼ ì•„í‹°ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  const lyrics = document.getElementById('addLyrics').value.trim();
  const lines = lyrics ? lyrics.split('\n').filter(l => l.trim()).map(l => ({ original: l.trim(), korean: '' })) : [{ original: '', korean: '' }];
  const emojis = ['ğŸµ','ğŸ¶','ğŸ¹','ğŸ·','ğŸº','ğŸ¥','ğŸ»','ğŸª—','ğŸ™ï¸','ğŸ§'];
  const gradients = [
    'linear-gradient(135deg,#667eea,#764ba2)',
    'linear-gradient(135deg,#f093fb,#f5576c)',
    'linear-gradient(135deg,#4facfe,#00f2fe)',
    'linear-gradient(135deg,#43e97b,#38f9d7)',
    'linear-gradient(135deg,#fa709a,#fee140)',
  ];
  const song = {
    id: 'u' + Date.now(),
    title, artist,
    emoji: emojis[Math.floor(Math.random()*emojis.length)],
    gradient: gradients[Math.floor(Math.random()*gradients.length)],
    links: {
      youtube: document.getElementById('addYoutube').value.trim() || null,
      spotify: document.getElementById('addSpotify').value.trim() || null,
    },
    lines
  };
  state.songs.unshift(song);
  saveState();
  state.currentSongId = song.id;
  state.view = 'editor';
  render();
  toast('ê³¡ì´ ë“±ë¡ë˜ì—ˆì–´ìš”!');
}

function deleteSong() {
  if (!confirm('ì´ ê³¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
  state.songs = state.songs.filter(s => s.id !== state.currentSongId);
  saveState();
  state.view = 'home';
  render();
  toast('ì‚­ì œ ì™„ë£Œ');
}

// --- AI Generation ---
async function aiGenerate() {
  const song = getCurrentSong();
  if (!song) return;
  const originals = song.lines.map(l => l.original).filter(l => l.trim());
  if (!originals.length) { toast('ì›ë¬¸ ê°€ì‚¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const statusEl = document.getElementById('aiStatus');
  statusEl.innerHTML = '<div class="ai-loading"><div class="spinner"></div>AIê°€ í•œê¸€ ëŠë‚Œê°€ì‚¬ë¥¼ ë§Œë“¤ê³  ìˆì–´ìš”...</div>';

  let optionText = '';
  if (state.aiOptions.stretch) optionText += '\n- ìŒì ˆì„ ì•½ê°„ ëŠ˜ë ¤ì„œ ë” ë¶€ë¥´ê¸° ì‰½ê²Œ (ì˜ˆ: "love" â†’ "ëŸ¬~ë¸Œ")';
  if (state.aiOptions.stress) optionText += '\n- ê°•ì„¸ê°€ ìˆëŠ” ìŒì ˆì€ êµµê²Œ ë˜ëŠ” ~ë¡œ ê°•ì¡° í‘œì‹œ';
  if (state.aiOptions.rhyme) optionText += '\n- í•œêµ­ì–´ì—ì„œë„ ë¼ì„/ìš´ìœ¨ì´ ëŠê»´ì§€ë„ë¡ ë°œìŒ ì¡°ì •';

  const prompt = `ë‹¤ìŒ ì˜ì–´ ê°€ì‚¬ë¥¼ í•œêµ­ì–´ ë°œìŒ(ëŠë‚Œê°€ì‚¬)ìœ¼ë¡œ ë³€í™˜í•´ì¤˜.
ê·œì¹™:
- ì˜ì–´ ë°œìŒì„ í•œê¸€ë¡œ ìµœëŒ€í•œ ìì—°ìŠ¤ëŸ½ê²Œ í‘œê¸°
- ë…¸ë˜ ë¶€ë¥¼ ë•Œ ë¦¬ë“¬ì— ë§ê²Œ ìŒì ˆ ìˆ˜ ì¡°ì ˆ
- ì›ë¬¸ì˜ ëŠë‚Œì„ ì‚´ë ¤ì„œ ë³€í™˜${optionText}

í˜•ì‹: ë°˜ë“œì‹œ ì•„ë˜ì²˜ëŸ¼ JSON ë°°ì—´ë¡œë§Œ ì‘ë‹µ (ë‹¤ë¥¸ í…ìŠ¤íŠ¸ ì—†ì´):
[{"original":"ì›ë¬¸","korean":"í•œê¸€ë°œìŒ"},...]

ê°€ì‚¬:
${originals.map((l,i) => `${i+1}. ${l}`).join('\n')}`;

  try {
    const res = await fetch(LLM_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + LLM_KEY },
      body: JSON.stringify({ model: 'spark', messages: [{ role: 'user', content: prompt }] })
    });
    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '';

    // Robust parse: strip think tags, find JSON
    let cleaned = text.replace(/<think>[\s\S]*?<\/think>/g, '').trim();
    const jsonMatch = cleaned.match(/\[[\s\S]*\]/);
    if (!jsonMatch) throw new Error('AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨');
    const result = JSON.parse(jsonMatch[0]);

    // Apply results
    result.forEach((r, i) => {
      if (i < song.lines.length && r.korean) {
        song.lines[i].korean = r.korean;
      }
    });
    saveState();
    statusEl.innerHTML = '';
    render();
    toast('âœ¨ ëŠë‚Œê°€ì‚¬ ìƒì„± ì™„ë£Œ!');
  } catch(err) {
    statusEl.innerHTML = `<div style="color:#ff4444;text-align:center;padding:12px;font-size:0.85rem">ìƒì„± ì‹¤íŒ¨: ${escHtml(err.message)}<br><span style="color:var(--text-dim)">ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”</span></div>`;
  }
}

// --- Karaoke ---
function openKaraoke() {
  const song = getCurrentSong();
  if (!song || !song.lines.length) return;
  const nonEmpty = song.lines.filter(l => l.korean.trim());
  if (!nonEmpty.length) { toast('í•œê¸€ ê°€ì‚¬ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }
  state.karaokeIndex = 0;
  renderKaraoke(song, nonEmpty);
}

function renderKaraoke(song, lines) {
  const overlay = document.getElementById('karaoke');
  const i = state.karaokeIndex;
  const line = lines[Math.min(i, lines.length - 1)];
  const done = i >= lines.length;

  overlay.innerHTML = `
    <button class="k-close" id="kClose">âœ•</button>
    ${done ? `
      <div class="k-korean" style="font-size:1.8rem">ğŸ¤ ë! ì˜í–ˆì–´ìš”!</div>
      <div class="k-progress">íƒ­í•˜ì—¬ ëŒì•„ê°€ê¸°</div>
    ` : `
      <div class="k-original">${escHtml(line.original)}</div>
      <div class="k-korean">${escHtml(line.korean)}</div>
      <div class="k-progress">${i+1} / ${lines.length}</div>
      <div class="k-hint">íƒ­ ë˜ëŠ” â†’í‚¤ë¡œ ë‹¤ìŒ</div>
    `}
  `;
  overlay.classList.add('active');
  document.body.style.overflow = 'hidden';

  const close = () => {
    overlay.classList.remove('active');
    document.body.style.overflow = '';
    overlay.removeEventListener('click', advance);
    document.removeEventListener('keydown', keyHandler);
  };

  const advance = (e) => {
    if (e.target.id === 'kClose') { close(); return; }
    if (done) { close(); return; }
    state.karaokeIndex++;
    renderKaraoke(song, lines);
  };

  const keyHandler = (e) => {
    if (e.key === 'Escape') { close(); return; }
    if (e.key === 'ArrowRight' || e.key === ' ') { e.preventDefault(); advance(e); }
    if (e.key === 'ArrowLeft' && state.karaokeIndex > 0) {
      e.preventDefault(); state.karaokeIndex--; renderKaraoke(song, lines);
    }
  };

  // Re-attach (previous listeners removed by innerHTML replacement)
  setTimeout(() => {
    overlay.addEventListener('click', advance);
    document.addEventListener('keydown', keyHandler);
    document.getElementById('kClose').addEventListener('click', close);
  }, 10);
}

// --- Export ---
function openExport() {
  const song = getCurrentSong();
  if (!song) return;
  const text = `${song.title} â€” ${song.artist}\n${'â”€'.repeat(30)}\n\n` +
    song.lines.map(l => `${l.original}\n${l.korean || '(ë¯¸ì…ë ¥)'}\n`).join('\n');

  const modal = document.getElementById('exportModal');
  modal.innerHTML = `
    <div class="modal-box">
      <h3>ğŸ“¤ ë‚´ë³´ë‚´ê¸°</h3>
      <pre id="exportText">${escHtml(text)}</pre>
      <div class="modal-actions">
        <button class="btn btn-primary" id="copyBtn">ğŸ“‹ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
        <button class="btn" id="closeExport">ë‹«ê¸°</button>
      </div>
    </div>
  `;
  modal.classList.add('active');

  document.getElementById('copyBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(text).then(() => toast('ë³µì‚¬ ì™„ë£Œ!')).catch(() => {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = text; document.body.appendChild(ta); ta.select();
      document.execCommand('copy'); document.body.removeChild(ta);
      toast('ë³µì‚¬ ì™„ë£Œ!');
    });
  });
  document.getElementById('closeExport').addEventListener('click', () => modal.classList.remove('active'));
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
}

// --- Util ---
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// --- Init ---
loadState();
render();
</script>
</body>
</html>
