/**
 * üåê API Router for Static Tools
 * URL ParameterÎ•º ÌååÏã±ÌïòÏó¨ API Í∏∞Îä• Ï†úÍ≥µ
 * Static HTMLÏóêÏÑú ÏÑúÎ≤ÑÎ¶¨Ïä§ APIÏ≤òÎüº ÎèôÏûë
 */

class APIRouter {
  constructor() {
    this.routes = new Map();
    this.middleware = [];
    this.setupDefaultRoutes();
  }

  // üõ£Ô∏è Í∏∞Î≥∏ ÎùºÏö∞Ìä∏ ÏÑ§Ï†ï
  setupDefaultRoutes() {
    // Base64 API ÎùºÏö∞Ìä∏
    this.addRoute('/base64', (params) => this.handleBase64API(params));
    this.addRoute('base64', (params) => this.handleBase64API(params)); // path without leading slash
    
    // JSON API ÎùºÏö∞Ìä∏
    this.addRoute('/json', (params) => this.handleJSONAPI(params));
    this.addRoute('json', (params) => this.handleJSONAPI(params));
    
    // URL API ÎùºÏö∞Ìä∏
    this.addRoute('/url', (params) => this.handleURLAPI(params));
    this.addRoute('url', (params) => this.handleURLAPI(params));
    
    // Hash API ÎùºÏö∞Ìä∏
    this.addRoute('/hash', (params) => this.handleHashAPI(params));
    this.addRoute('hash', (params) => this.handleHashAPI(params));
  }

  // üìù ÎùºÏö∞Ìä∏ Ï∂îÍ∞Ä
  addRoute(path, handler) {
    this.routes.set(path, handler);
  }

  // üîß ÎØ∏Îì§Ïõ®Ïñ¥ Ï∂îÍ∞Ä
  addMiddleware(middleware) {
    this.middleware.push(middleware);
  }

  // üéØ URL ÌååÎùºÎØ∏ÌÑ∞ ÌååÏã±
  parseParams() {
    const params = new URLSearchParams(window.location.search);
    const result = {};
    
    for (const [key, value] of params.entries()) {
      result[key] = value;
    }
    
    return result;
  }

  // üîç ÌòÑÏû¨ Í≤ΩÎ°ú Í∞êÏßÄ
  getCurrentPath() {
    const pathname = window.location.pathname;
    const segments = pathname.split('/').filter(Boolean);
    
    // ÎßàÏßÄÎßâ ÏÑ∏Í∑∏Î®ºÌä∏ ÎòêÎäî Ï†ÑÏ≤¥ Í≤ΩÎ°ú Î∞òÌôò
    if (segments.length > 0) {
      const lastSegment = segments[segments.length - 1];
      if (lastSegment.includes('.html')) {
        // HTML ÌååÏùºÏù∏ Í≤ΩÏö∞ ÎîîÎ†âÌÜ†Î¶¨Î™Ö ÏÇ¨Ïö©
        return segments[segments.length - 2] || segments[segments.length - 1].replace('.html', '');
      }
      return lastSegment;
    }
    
    return pathname;
  }

  // üì§ ÏùëÎãµ Ìè¨Îß∑ÌÑ∞
  formatResponse(data, format = 'text', status = 200) {
    const timestamp = new Date().toISOString();
    
    if (format === 'json') {
      return JSON.stringify({
        success: status === 200,
        result: data,
        timestamp: timestamp,
        status: status
      }, null, 2);
    }
    
    return data;
  }

  // ‚ùå ÏóêÎü¨ ÏùëÎãµ Ìè¨Îß∑ÌÑ∞
  formatErrorResponse(error, format = 'text', status = 400) {
    const timestamp = new Date().toISOString();
    
    if (format === 'json') {
      return JSON.stringify({
        success: false,
        error: error,
        timestamp: timestamp,
        status: status
      }, null, 2);
    }
    
    return `Error: ${error}`;
  }

  // üì¶ Base64 API Ìï∏Îì§Îü¨
  handleBase64API(params) {
    const { action, text = '', charset = 'utf-8', format = 'text' } = params;
    
    try {
      if (!action) {
        return this.formatErrorResponse('Missing required parameter: action', format);
      }
      
      if (!text && action !== 'help') {
        return this.formatErrorResponse('Missing required parameter: text', format);
      }
      
      const options = { charset };
      let result;
      
      switch (action.toLowerCase()) {
        case 'encode':
          result = Base64Tool.encode(text, options);
          break;
        case 'decode':
          result = Base64Tool.decode(text, options);
          break;
        case 'auto':
          result = Base64Tool.convert(text, { ...options, mode: 'auto' });
          break;
        case 'help':
          return this.formatResponse(this.getBase64Help(), format);
        default:
          return this.formatErrorResponse(`Invalid action: ${action}. Use 'encode', 'decode', 'auto', or 'help'`, format);
      }
      
      if (result.success) {
        return this.formatResponse(result.data, format);
      } else {
        return this.formatErrorResponse(result.error, format);
      }
    } catch (error) {
      return this.formatErrorResponse(error.message, format, 500);
    }
  }

  // üîß JSON API Ìï∏Îì§Îü¨
  handleJSONAPI(params) {
    const { action, json = '', indent = '2', sort_keys = 'false', format = 'text' } = params;
    
    try {
      if (!action) {
        return this.formatErrorResponse('Missing required parameter: action', format);
      }
      
      if (!json && action !== 'help') {
        return this.formatErrorResponse('Missing required parameter: json', format);
      }
      
      const options = {
        indent: parseInt(indent),
        sortKeys: sort_keys.toLowerCase() === 'true',
        minify: action === 'minify'
      };
      
      let result;
      
      switch (action.toLowerCase()) {
        case 'format':
        case 'pretty':
          result = JSONTool.format(json, options);
          break;
        case 'minify':
          result = JSONTool.minify(json);
          break;
        case 'validate':
          result = JSONTool.validate(json);
          break;
        case 'help':
          return this.formatResponse(this.getJSONHelp(), format);
        default:
          return this.formatErrorResponse(`Invalid action: ${action}. Use 'format', 'minify', 'validate', or 'help'`, format);
      }
      
      if (result.success) {
        return this.formatResponse(result.data, format);
      } else {
        return this.formatErrorResponse(result.error, format);
      }
    } catch (error) {
      return this.formatErrorResponse(error.message, format, 500);
    }
  }

  // üîó URL API Ìï∏Îì§Îü¨
  handleURLAPI(params) {
    const { action, text = '', component = 'true', format = 'text' } = params;
    
    try {
      if (!action) {
        return this.formatErrorResponse('Missing required parameter: action', format);
      }
      
      if (!text && action !== 'help') {
        return this.formatErrorResponse('Missing required parameter: text', format);
      }
      
      const options = {
        component: component.toLowerCase() === 'true'
      };
      
      let result;
      
      switch (action.toLowerCase()) {
        case 'encode':
          result = URLTool.encode(text, options);
          break;
        case 'decode':
          result = URLTool.decode(text, options);
          break;
        case 'auto':
          result = URLTool.convert(text, { ...options, mode: 'auto' });
          break;
        case 'help':
          return this.formatResponse(this.getURLHelp(), format);
        default:
          return this.formatErrorResponse(`Invalid action: ${action}. Use 'encode', 'decode', 'auto', or 'help'`, format);
      }
      
      if (result.success) {
        return this.formatResponse(result.data, format);
      } else {
        return this.formatErrorResponse(result.error, format);
      }
    } catch (error) {
      return this.formatErrorResponse(error.message, format, 500);
    }
  }

  // üîê Hash API Ìï∏Îì§Îü¨
  async handleHashAPI(params) {
    const { action, text = '', format = 'text' } = params;
    
    try {
      if (!action) {
        return this.formatErrorResponse('Missing required parameter: action', format);
      }
      
      if (!text && action !== 'help') {
        return this.formatErrorResponse('Missing required parameter: text', format);
      }
      
      let result;
      
      switch (action.toLowerCase()) {
        case 'md5':
          result = await HashTool.md5(text);
          break;
        case 'sha256':
          result = await HashTool.sha256(text);
          break;
        case 'help':
          return this.formatResponse(this.getHashHelp(), format);
        default:
          return this.formatErrorResponse(`Invalid action: ${action}. Use 'md5', 'sha256', or 'help'`, format);
      }
      
      if (result.success) {
        return this.formatResponse(result.data, format);
      } else {
        return this.formatErrorResponse(result.error, format);
      }
    } catch (error) {
      return this.formatErrorResponse(error.message, format, 500);
    }
  }

  // üìö ÎèÑÏõÄÎßê Î©îÏãúÏßÄÎì§
  getBase64Help() {
    return `Base64 API Usage:
    
?action=encode&text=Hello World
?action=decode&text=SGVsbG8gV29ybGQ=
?action=auto&text=Hello (auto-detects if encode/decode needed)

Optional parameters:
- charset: utf-8, iso-8859-1, windows-1252 (default: utf-8)
- format: text, json (default: text)

Examples:
/base64?action=encode&text=Hello World&format=json
/base64?action=decode&text=SGVsbG8gV29ybGQ=&charset=utf-8`;
  }

  getJSONHelp() {
    return `JSON API Usage:
    
?action=format&json={"name":"John","age":30}
?action=minify&json={"name": "John", "age": 30}
?action=validate&json={"test": true}

Optional parameters:
- indent: 2, 4, 8 (default: 2, for format action)
- sort_keys: true, false (default: false)
- format: text, json (default: text)

Examples:
/json?action=format&json={"name":"John"}&indent=4&sort_keys=true
/json?action=validate&json={"test":true}&format=json`;
  }

  getURLHelp() {
    return `URL API Usage:
    
?action=encode&text=hello world
?action=decode&text=hello%20world
?action=auto&text=hello world (auto-detects if encode/decode needed)

Optional parameters:
- component: true, false (default: true)
  true: uses encodeURIComponent (for query params)
  false: uses encodeURI (for full URLs)
- format: text, json (default: text)

Examples:
/url?action=encode&text=hello world&component=true
/url?action=decode&text=hello%20world&format=json`;
  }

  getHashHelp() {
    return `Hash API Usage:
    
?action=md5&text=Hello World
?action=sha256&text=Hello World

Optional parameters:
- format: text, json (default: text)

Examples:
/hash?action=sha256&text=Hello World&format=json
/hash?action=md5&text=secret password`;
  }

  // üöÄ Î©îÏù∏ ÎùºÏö∞ÌÑ∞ Ïã§Ìñâ
  async route() {
    const params = this.parseParams();
    const path = this.getCurrentPath();
    
    // ÎØ∏Îì§Ïõ®Ïñ¥ Ïã§Ìñâ
    for (const middleware of this.middleware) {
      const result = await middleware(params, path);
      if (result === false) {
        return; // ÎØ∏Îì§Ïõ®Ïñ¥ÏóêÏÑú Ï§ëÎã®
      }
    }
    
    // API ÏöîÏ≤≠Ïù∏ÏßÄ ÌôïÏù∏ (action ÌååÎùºÎØ∏ÌÑ∞Í∞Ä ÏûàÎäîÏßÄ)
    if (!params.action) {
      return; // ÏùºÎ∞ò ÌéòÏù¥ÏßÄ Î°úÎìú
    }
    
    // ÎùºÏö∞Ìä∏ Ìï∏Îì§Îü¨ Ï∞æÍ∏∞
    const handler = this.routes.get(path) || this.routes.get(`/${path}`);
    
    if (!handler) {
      const errorResponse = this.formatErrorResponse(
        `Unknown API endpoint: ${path}. Available endpoints: base64, json, url, hash`,
        params.format || 'text',
        404
      );
      this.renderAPIResponse(errorResponse);
      return;
    }
    
    try {
      // Ìï∏Îì§Îü¨ Ïã§Ìñâ
      const response = await handler(params);
      this.renderAPIResponse(response);
    } catch (error) {
      const errorResponse = this.formatErrorResponse(
        `Internal server error: ${error.message}`,
        params.format || 'text',
        500
      );
      this.renderAPIResponse(errorResponse);
    }
  }

  // üìÑ API ÏùëÎãµÏùÑ ÌéòÏù¥ÏßÄÏóê Î†åÎçîÎßÅ
  renderAPIResponse(response) {
    document.body.innerHTML = `
      <pre style="
        background: #1a1a1a;
        color: #fff;
        padding: 20px;
        font-family: 'Fira Code', 'Monaco', monospace;
        font-size: 14px;
        line-height: 1.6;
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        min-height: 100vh;
      ">${response}</pre>
    `;
    
    // Content-Type Ìó§Îçî ÏÑ§Ï†ï (Í∞ÄÎä•Ìïú Í≤ΩÏö∞)
    try {
      const params = this.parseParams();
      if (params.format === 'json') {
        document.querySelector('pre').style.background = '#0f1419';
        document.querySelector('pre').style.color = '#d4d4d4';
      }
    } catch (e) {
      // Î¨¥Ïãú
    }
  }

  // üîß CORS ÎØ∏Îì§Ïõ®Ïñ¥ (ÌïÑÏöîÏãú)
  static corsMiddleware() {
    return async (params, path) => {
      // CORS Ìó§Îçî ÏÑ§Ï†ï (Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî Ïã§Ï†úÎ°ú Ï†ÅÏö©ÎêòÏßÄ ÏïäÏßÄÎßå Î¨∏ÏÑúÌôî Î™©Ï†Å)
      console.log('CORS: Access-Control-Allow-Origin: *');
      console.log('CORS: Access-Control-Allow-Methods: GET, POST, OPTIONS');
      console.log('CORS: Access-Control-Allow-Headers: Content-Type');
      return true;
    };
  }

  // üìä Î°úÍπÖ ÎØ∏Îì§Ïõ®Ïñ¥
  static loggingMiddleware() {
    return async (params, path) => {
      const timestamp = new Date().toISOString();
      console.log(`[${timestamp}] API Request: ${path}`, params);
      return true;
    };
  }
}

// üåê Ï†ÑÏó≠ API ÎùºÏö∞ÌÑ∞ Ïù∏Ïä§ÌÑ¥Ïä§
window.APIRouter = APIRouter;

// üöÄ ÏûêÎèô Ï¥àÍ∏∞Ìôî Î∞è ÎùºÏö∞ÌåÖ
document.addEventListener('DOMContentLoaded', async () => {
  const router = new APIRouter();
  
  // ÎØ∏Îì§Ïõ®Ïñ¥ Ï∂îÍ∞Ä
  router.addMiddleware(APIRouter.loggingMiddleware());
  router.addMiddleware(APIRouter.corsMiddleware());
  
  // ÎùºÏö∞ÌåÖ Ïã§Ìñâ
  await router.route();
});

console.log('üåê API Router loaded successfully!');
